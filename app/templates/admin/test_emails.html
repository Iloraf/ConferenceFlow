{% extends 'base.html' %}

{% block title %}Test des emails - Administration{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-envelope-open-text me-2"></i>
                Test du système d'emails
            </h2>
            
            <!-- Info configuration -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Configuration actuelle
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Conférence :</strong> {{ conference.name|safe or 'Non configuré' }}</p>
                            <p><strong>Nom court :</strong> {{ conference.short_name or 'Non configuré' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Email contact :</strong> {{ conference_contacts.general.email or 'Non configuré' }}</p>
                            <p><strong>Lieu :</strong> {{ conference_location.city or 'Non configuré' }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Formulaire de test -->
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>
                        Configuration des tests
                    </h5>
                </div>
                <div class="card-body">
                    <form id="emailTestForm">
                        <!-- Email de test -->
                        <div class="mb-4">
                            <label for="test_email" class="form-label">
                                <i class="fas fa-at me-1"></i>
                                Adresse email de test
                            </label>
                            <input type="email" class="form-control" id="test_email" name="test_email" 
                                   value="{{ current_user.email }}" required>
                            <div class="form-text">
                                Tous les emails de test seront envoyés à cette adresse
                            </div>
                        </div>
                        
                        <!-- Mode simulation -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="dry_run" name="dry_run" checked>
                                <label class="form-check-label" for="dry_run">
                                    <i class="fas fa-eye me-1"></i>
                                    Mode simulation (ne pas envoyer les emails)
                                </label>
                            </div>
                            <div class="form-text">
                                En mode simulation, les tests s'exécutent sans envoyer d'emails
                            </div>
                        </div>
                        
                        <!-- Sélection des tests -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-list-check me-1"></i>
                                Tests à exécuter
                            </label>
                            
                            <div class="row">
                                <!-- Section Confirmations de soumission -->
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-success text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-upload me-2"></i>
                                                Confirmations de soumission
                                            </h6>
                                        </div>
                                        <div class="card-body">

<div class="form-check">
    <input class="form-check-input" type="checkbox" id="submission_resume" name="email_tests" value="submission_resume">
    <label class="form-check-label" for="submission_resume">Confirmation résumé</label>
</div>
<div class="form-check">
    <input class="form-check-input" type="checkbox" id="submission_article" name="email_tests" value="submission_article">
    <label class="form-check-label" for="submission_article">Confirmation article</label>
</div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_wip_confirmation" 
                                                       name="email_tests" value="wip_confirmation">
                                                <label class="form-check-label" for="test_wip_confirmation">
                                                    Confirmation WIP
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_poster_confirmation" 
                                                       name="email_tests" value="poster_confirmation">
                                                <label class="form-check-label" for="test_poster_confirmation">
                                                    Confirmation poster
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_revision_confirmation" 
                                                       name="email_tests" value="revision_confirmation">
                                                <label class="form-check-label" for="test_revision_confirmation">
                                                    Confirmation révision
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section Utilisateurs -->
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-primary text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-users me-2"></i>
                                                Emails utilisateurs
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_activation" 
                                                       name="email_tests" value="activation">
                                                <label class="form-check-label" for="test_activation">
                                                    Email d'activation reviewer
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_reviewer_welcome" 
                                                       name="email_tests" value="reviewer_welcome">
                                                <label class="form-check-label" for="test_reviewer_welcome">
                                                    Bienvenue reviewer
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_coauthor_new" 
                                                       name="email_tests" value="coauthor_new">
                                                <label class="form-check-label" for="test_coauthor_new">
                                                    Notification co-auteur (nouveau)
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_coauthor_existing" 
                                                       name="email_tests" value="coauthor_existing">
                                                <label class="form-check-label" for="test_coauthor_existing">
                                                    Notification co-auteur (existant)
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_qr_code" 
                                                       name="email_tests" value="qr_code">
                                                <label class="form-check-label" for="test_qr_code">
                                                    Rappel QR code poster
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section Reviews & Décisions -->
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-warning text-dark">
                                            <h6 class="mb-0">
                                                <i class="fas fa-clipboard-check me-2"></i>
                                                Reviews & Décisions
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_review_reminder" 
                                                       name="email_tests" value="review_reminder">
                                                <label class="form-check-label" for="test_review_reminder">
                                                    Rappel review en attente
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_decision_accept" 
                                                       name="email_tests" value="decision_accept">
                                                <label class="form-check-label" for="test_decision_accept">
                                                    Décision : Acceptation
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_decision_reject" 
                                                       name="email_tests" value="decision_reject">
                                                <label class="form-check-label" for="test_decision_reject">
                                                    Décision : Refus
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_decision_revise" 
                                                       name="email_tests" value="decision_revise">
                                                <label class="form-check-label" for="test_decision_revise">
                                                    Décision : Révisions
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_biot_fourier" 
                                                       name="email_tests" value="biot_fourier">
                                                <label class="form-check-label" for="test_biot_fourier">
                                                    Nomination Biot-Fourier
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Section Administration -->
                                <div class="col-md-6">
                                    <div class="card mb-3">
                                        <div class="card-header bg-secondary text-white">
                                            <h6 class="mb-0">
                                                <i class="fas fa-tools me-2"></i>
                                                Administration
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_admin_weekly_summary" 
                                                       name="email_tests" value="admin_weekly_summary">
                                                <label class="form-check-label" for="test_admin_weekly_summary">
                                                    Résumé hebdomadaire
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_admin_alert" 
                                                       name="email_tests" value="admin_alert">
                                                <label class="form-check-label" for="test_admin_alert">
                                                    Alerte admin
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="test_hal_collection" 
                                                       name="email_tests" value="hal_collection">
                                                <label class="form-check-label" for="test_hal_collection">
                                                    Demande collection HAL
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Boutons de sélection -->
                            <div class="mt-3">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllTests()">
                                    <i class="fas fa-check-double me-1"></i>Tout sélectionner
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="unselectAllTests()">
                                    <i class="fas fa-times me-1"></i>Tout désélectionner
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-success" onclick="selectConfirmationTests()">
                                    <i class="fas fa-upload me-1"></i>Confirmations uniquement
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="selectBasicTests()">
                                    <i class="fas fa-star me-1"></i>Tests de base
                                </button>
                            </div>
                        </div>
                        
                        <!-- Boutons d'action -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>Retour
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-play me-1"></i>Lancer les tests
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Résultats -->
            <div id="resultsSection" class="card mt-4" style="display: none;">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        Résultats des tests
                    </h5>
                </div>
                <div class="card-body">
                    <div id="testResults"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Sélectionner tous les tests
function selectAllTests() {
    document.querySelectorAll('input[name="email_tests"]').forEach(cb => cb.checked = true);
}

// Désélectionner tous les tests
function unselectAllTests() {
    document.querySelectorAll('input[name="email_tests"]').forEach(cb => cb.checked = false);
}

// Sélectionner uniquement les tests de confirmation
function selectConfirmationTests() {
    unselectAllTests();
    const confirmationTests = [
        'resume_confirmation', 'article_confirmation', 'wip_confirmation', 
        'poster_confirmation', 'revision_confirmation'
    ];
    confirmationTests.forEach(test => {
        const checkbox = document.getElementById(`test_${test}`);
        if (checkbox) checkbox.checked = true;
    });
}

// Sélectionner les tests de base
function selectBasicTests() {
    unselectAllTests();
    const basicTests = [
        'activation', 'coauthor_new', 'decision_accept', 'resume_confirmation', 'article_confirmation'
    ];
    basicTests.forEach(test => {
        const checkbox = document.getElementById(`test_${test}`);
        if (checkbox) checkbox.checked = true;
    });
}

// Soumission du formulaire
document.getElementById('emailTestForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const selectedTests = formData.getAll('email_tests');
    
    if (selectedTests.length === 0) {
        alert('Veuillez sélectionner au moins un test');
        return;
    }
    
    // Afficher le loading
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Tests en cours...';
    submitBtn.disabled = true;
    
    // Cacher les anciens résultats
    document.getElementById('resultsSection').style.display = 'none';
    
    // Envoyer la requête
    fetch('{{ url_for("admin.run_email_tests") }}', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Restaurer le bouton
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        // Afficher les résultats
        displayResults(data);
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de l\'exécution des tests');
        
        // Restaurer le bouton
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

function displayResults(data) {
    const resultsDiv = document.getElementById('testResults');
    const resultsSection = document.getElementById('resultsSection');
    
    let html = '';
    
    // Résumé
    const successClass = data.success ? 'alert-success' : 'alert-danger';
    html += `<div class="alert ${successClass}">`;
    html += `<h6 class="mb-2"><i class="fas fa-info-circle me-1"></i>${data.message}</h6>`;
    if (data.dry_run) {
        html += `<small><i class="fas fa-eye me-1"></i>Mode simulation - Aucun email n'a été envoyé</small>`;
    }
    html += `</div>`;
    
    // Détails des tests par catégorie
    if (data.results && data.results.length > 0) {
        // Grouper les résultats par catégorie
        const categories = {
            'Confirmations': [],
            'Utilisateurs': [],
            'Reviews & Décisions': [],
            'Administration': [],
            'Configuration': []
        };
        
        data.results.forEach(result => {
            if (result.test.includes('confirmation')) {
                categories['Confirmations'].push(result);
            } else if (result.test.includes('activation') || result.test.includes('co-auteur') || result.test.includes('QR') || result.test.includes('reviewer')) {
                categories['Utilisateurs'].push(result);
            } else if (result.test.includes('review') || result.test.includes('décision') || result.test.includes('Biot-Fourier')) {
                categories['Reviews & Décisions'].push(result);
            } else if (result.test.includes('admin') || result.test.includes('HAL') || result.test.includes('alerte') || result.test.includes('résumé')) {
                categories['Administration'].push(result);
            } else {
                categories['Configuration'].push(result);
            }
        });
        
        // Afficher par catégorie
        Object.entries(categories).forEach(([category, results]) => {
            if (results.length > 0) {
                html += `<h6 class="mt-4 mb-3">${category}</h6>`;
                html += `<div class="row">`;
                
                results.forEach(result => {
                    const statusClass = result.success ? 'border-success' : 'border-danger';
                    const bgClass = result.success ? 'bg-light' : 'bg-light';
                    const iconClass = result.success ? 'fas fa-check-circle text-success' : 'fas fa-exclamation-circle text-danger';
                    
                    html += `<div class="col-md-6 mb-3">`;
                    html += `<div class="card ${statusClass} ${bgClass}">`;
                    html += `<div class="card-body">`;
                    html += `<h6 class="card-title">`;
                    html += `<i class="${iconClass} me-2"></i>${result.test}`;
                    html += `</h6>`;
                    html += `<p class="card-text small">${result.message}</p>`;
                    html += `</div>`;
                    html += `</div>`;
                    html += `</div>`;
                });
                
                html += `</div>`;
            }
        });
    }
    
    resultsDiv.innerHTML = html;
    resultsSection.style.display = 'block';
    
    // Scroller vers les résultats
    resultsSection.scrollIntoView({ behavior: 'smooth' });
}
</script>
{% endblock %}

