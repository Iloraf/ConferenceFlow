{% extends 'base.html' %}

{% block title %}Aide - Import des reviewers{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- En-tête -->
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="{{ url_for('admin.admin_dashboard') }}">Administration</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('admin.import_reviewers_page') }}">Import reviewers</a></li>
                <li class="breadcrumb-item active">Aide</li>
            </ol>
        </nav>
        <h1 class="h2 text-primary">
            <i class="fas fa-question-circle me-2"></i>Guide d'import des reviewers
        </h1>
        <p class="text-muted">Tout ce que vous devez savoir pour importer vos reviewers avec leurs spécialités</p>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Guide d'utilisation -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-book me-2"></i>Guide d'utilisation
                    </h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="guideAccordion">
                        <!-- Étape 1 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="step1">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse1">
                                    <i class="fas fa-user-plus text-primary me-2"></i>
                                    <strong>Étape 1 : Préparer votre fichier CSV</strong>
                                </button>
                            </h2>
                            <div id="collapse1" class="accordion-collapse collapse show" data-bs-parent="#guideAccordion">
                                <div class="accordion-body">
                                    <p>Vous avez deux options pour créer votre fichier CSV :</p>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-success">
                                                <i class="fas fa-check-circle me-1"></i>Option 1 : Format simple
                                            </h6>
                                            <ul class="small">
                                                <li>Un email par ligne</li>
                                                <li>Pas d'en-tête</li>
                                                <li>Rétrocompatible</li>
                                                <li>Spécialités à assigner manuellement après</li>
                                            </ul>
                                            <pre class="bg-light p-2 small"><code>user1@example.com
user2@example.com</code></pre>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-primary">
                                                <i class="fas fa-star me-1"></i>Option 2 : Format avec spécialités
                                            </h6>
                                            <ul class="small">
                                                <li>Avec en-tête : <code>email;thematiques</code></li>
                                                <li>Codes de thématiques séparés par virgules</li>
                                                <li>Tout en une fois</li>
                                                <li>Gain de temps considérable</li>
                                            </ul>
                                            <pre class="bg-light p-2 small"><code>email;thematiques
user1@example.com;COND,MULTI
user2@example.com;BIO</code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Étape 2 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="step2">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    <strong>Étape 2 : Vérifier les prérequis</strong>
                                </button>
                            </h2>
                            <div id="collapse2" class="accordion-collapse collapse" data-bs-parent="#guideAccordion">
                                <div class="accordion-body">
                                    <div class="alert alert-warning">
                                        <h6 class="alert-heading">
                                            <i class="fas fa-exclamation-triangle me-2"></i>Prérequis obligatoires
                                        </h6>
                                        <ul class="mb-0">
                                            <li><strong>Utilisateurs existants :</strong> Tous les emails doivent correspondre à des utilisateurs déjà enregistrés</li>
                                            <li><strong>Encodage UTF-8 :</strong> Sauvegardez votre fichier CSV en UTF-8</li>
                                            <li><strong>Séparateur :</strong> Utilisez le point-virgule (;) pour séparer les colonnes</li>
                                            <li><strong>Codes valides :</strong> Les codes de thématiques doivent être exacts (voir liste ci-contre)</li>
                                        </ul>
                                    </div>
                                    
                                    <h6 class="mt-3">Vérifications automatiques lors de l'import :</h6>
                                    <ul class="small">
                                        <li>✅ Existence des utilisateurs</li>
                                        <li>✅ Validité des codes de thématiques</li>
                                        <li>✅ Format du fichier CSV</li>
                                        <li>✅ Doublons et erreurs</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Étape 3 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="step3">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse3">
                                    <i class="fas fa-upload text-info me-2"></i>
                                    <strong>Étape 3 : Importer le fichier</strong>
                                </button>
                            </h2>
                            <div id="collapse3" class="accordion-collapse collapse" data-bs-parent="#guideAccordion">
                                <div class="accordion-body">
                                    <ol>
                                        <li>Retournez à la <a href="{{ url_for('admin.import_reviewers_page') }}">page d'import</a></li>
                                        <li>Sélectionnez votre fichier CSV</li>
                                        <li>Le format sera détecté automatiquement</li>
                                        <li>Cliquez sur "Importer les reviewers"</li>
                                        <li>Consultez les résultats et messages d'erreur éventuels</li>
                                    </ol>
                                    
                                    <div class="alert alert-info">
                                        <strong>Que se passe-t-il lors de l'import ?</strong>
                                        <ul class="mb-0 mt-2">
                                            <li>Les utilisateurs non-reviewers sont promus</li>
                                            <li>Les spécialités sont assignées (remplace les existantes)</li>
                                            <li>Un rapport détaillé est généré</li>
                                            <li>Les erreurs sont listées pour correction</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exemples détaillés -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>Exemples de fichiers CSV
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">Exemple complet avec spécialités :</h6>
                            <pre class="bg-light p-3 small rounded"><code>email;thematiques
prof.dupont@univ.fr;COND,MULTI,POREUX
dr.martin@cnrs.fr;BIO,SIMUL
expert@company.com;ECHANG,STOCK,RENOUV
researcher@lab.org;METRO,SIMUL,INDUS,COND</code></pre>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info">Cas particuliers gérés :</h6>
                            <pre class="bg-light p-3 small rounded"><code>email;thematiques
reviewer1@test.com;COND,MULTI
reviewer2@test.com;
reviewer3@test.com;INVALID_CODE,BIO
# Cette ligne est ignorée
reviewer4@test.com;BIO</code></pre>
                            <small class="text-muted">
                                • Lignes vides : ignorées<br>
                                • Spécialités vides : promotion sans spécialités<br>
                                • Codes invalides : erreur signalée<br>
                                • Commentaires (#) : ignorés
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Liste des thématiques -->
            <div class="card mb-4 position-sticky" style="top: 20px;">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-tags me-2"></i>Codes de thématiques disponibles
                    </h6>
                </div>
                <div class="card-body">
                    {% if thematiques %}
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Code</th>
                                    <th>Thématique</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for thematique in thematiques %}
                                <tr>
                                    <td>
                                        <span class="badge text-white" style="background-color: {{ thematique.couleur }};">
                                            {{ thematique.code }}
                                        </span>
                                    </td>
                                    <td class="small">{{ thematique.nom }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary w-100" onclick="copyAllCodes()">
                            <i class="fas fa-copy me-1"></i>Copier tous les codes
                        </button>
                    </div>
                    {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>Aucune thématique configurée</p>
                        <a href="{{ url_for('admin.manage_thematiques') }}" class="btn btn-sm btn-primary">
                            Configurer les thématiques
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Actions rapides -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Actions rapides
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('admin.download_reviewers_template') }}" class="btn btn-success">
                            <i class="fas fa-download me-2"></i>Télécharger le template
                        </a>
                        <a href="{{ url_for('admin.import_reviewers_page') }}" class="btn btn-primary">
                            <i class="fas fa-upload me-2"></i>Importer maintenant
                        </a>
                        <a href="{{ url_for('admin.manage_thematiques') }}" class="btn btn-outline-info">
                            <i class="fas fa-tags me-2"></i>Gérer les thématiques
                        </a>
                        <a href="{{ url_for('admin.manage_reviewer_specialites') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-user-tag me-2"></i>Voir les spécialités actuelles
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function copyAllCodes() {
    const codes = [];
    document.querySelectorAll('.badge').forEach(badge => {
        codes.push(badge.textContent.trim());
    });
    
    const codesText = codes.join(',');
    
    navigator.clipboard.writeText(codesText).then(function() {
        // Afficher une confirmation
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copié !';
        btn.classList.remove('btn-outline-primary');
        btn.classList.add('btn-success');
        
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    }).catch(function(err) {
        console.error('Erreur lors de la copie: ', err);
    });
}

// Animation d'entrée pour les cartes
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.card');
    cards.forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(20px)';
        setTimeout(() => {
            card.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, index * 100);
    });
});
</script>

<style>
.accordion-button:not(.collapsed) {
    background-color: #f8f9fa;
    color: #0d6efd;
}

.badge {
    font-size: 0.75em;
    min-width: 50px;
    text-align: center;
}

.table-sm td, .table-sm th {
    padding: 0.5rem 0.25rem;
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
}

pre code {
    font-size: 0.8em;
    line-height: 1.4;
}

.position-sticky {
    position: -webkit-sticky;
    position: sticky;
}
</style>
{% endblock %}
