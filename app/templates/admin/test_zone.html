<!-- Cr√©er le fichier : templates/admin/test_zone.html -->
{% extends "base.html" %}

{% block title %}Zone de Test - Administration{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1><i class="fas fa-flask text-warning"></i> Zone de Test</h1>
                    <p class="text-muted">Outils de d√©veloppement et de test pour SFT 2026</p>
                </div>
                <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Retour Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Statistiques actuelles -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> √âtat actuel de la base de donn√©es</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-primary">{{ stats.affiliations }}</h3>
                                <small>Affiliations</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-success">{{ stats.users_total }}</h3>
                                <small>Utilisateurs</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-warning">{{ stats.users_reviewers }}</h3>
                                <small>Reviewers</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-info">{{ stats.communications }}</h3>
                                <small>Communications</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-secondary">{{ stats.files_uploaded }}</h3>
                                <small>Fichiers</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-danger">{{ stats.users_test }}</h3>
                                <small>Comptes test</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 1: Configuration initiale -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-database"></i> 1. Configuration initiale</h5>
                </div>
                <div class="card-body">
                    <p>Pr√©parer la base de donn√©es avec les donn√©es de base.</p>
                    
                    <div class="mb-3">
                        <strong>Fichier labos.csv :</strong>
                        {% if file_status.labos_csv_exists %}
                            <span class="badge bg-success ms-2">‚úì Trouv√©</span>
                        {% else %}
                            <span class="badge bg-danger ms-2">‚úó Manquant</span>
                        {% endif %}
                        <br><small class="text-muted">{{ file_status.csv_path }}</small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('admin.import_affiliations_csv') }}" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Importer les affiliations
                        </a>
                        <a href="{{ url_for('admin.setup_status') }}" class="btn btn-outline-primary">
                            <i class="fas fa-info-circle"></i> V√©rifier le statut
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-users"></i> 2. Donn√©es de test</h5>
                </div>
                <div class="card-body">
                    <p>Cr√©er des utilisateurs et reviewers factices pour les tests.</p>
                    
                    <div class="mb-3">
                        <strong>Comptes de test actuels :</strong>
                        <span class="badge bg-info ms-2">{{ stats.users_test }} comptes</span>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('admin.generate_test_data') }}" class="btn btn-success">
                            <i class="fas fa-user-plus"></i> G√©n√©rer utilisateurs test
                        </a>
                        <a href="{{ url_for('admin.cleanup_test_data') }}" class="btn btn-outline-danger">
                            <i class="fas fa-trash"></i> Nettoyer les donn√©es test
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 2: Fichiers de test -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-file-pdf"></i> 3. Documents de test</h5>
                </div>
                <div class="card-body">
                    <p>G√©n√©rer des PDF de test pour tous les types de documents.</p>
                    
                    <div class="mb-3">
                        <strong>PDFs de test :</strong>
                        {% if file_status.test_pdfs_exist %}
                            <span class="badge bg-success ms-2">‚úì G√©n√©r√©s</span>
                        {% else %}
                            <span class="badge bg-secondary ms-2">? Non g√©n√©r√©s</span>
                        {% endif %}
                        <br><small class="text-muted">{{ file_status.pdfs_dir }}</small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('admin.generate_test_pdfs') }}" class="btn btn-warning">
                            <i class="fas fa-file-pdf"></i> G√©n√©rer PDFs de test
                        </a>
                        {% if file_status.test_pdfs_exist %}
                        <button class="btn btn-outline-info" onclick="listTestFiles()">
                            <i class="fas fa-list"></i> Voir les fichiers g√©n√©r√©s
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-vials"></i> 4. Tests fonctionnels</h5>
                </div>
                <div class="card-body">
                    <p>Tester les fonctionnalit√©s cl√©s de l'application.</p>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('main.mes_communications') }}" class="btn btn-outline-info" target="_blank">
                            <i class="fas fa-eye"></i> Voir mes communications
                        </a>
                        <a href="{{ url_for('main.choose_type') }}" class="btn btn-outline-success" target="_blank">
                            <i class="fas fa-plus"></i> Tester soumission
                        </a>
                        <a href="{{ url_for('admin.manage_users') }}" class="btn btn-outline-warning" target="_blank">
                            <i class="fas fa-users-cog"></i> Gestion utilisateurs
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 3: Tests HAL -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-archive text-info"></i> 5. Tests du syst√®me HAL</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>Workflow de test HAL recommand√© :</h6>
                            <ol class="mb-3">
                                <li>V√©rifier que vous avez un <strong>IDHAL</strong> renseign√© dans votre profil</li>
                                <li>Cr√©er une communication avec les <strong>PDFs de test</strong></li>
                                <li>V√©rifier que la <strong>case HAL est coch√©e</strong> par d√©faut</li>
                                <li>Tester les <strong>validations JavaScript</strong> (IDHAL manquant)</li>
                                <li>Voir le <strong>statut HAL</strong> dans "Mes Communications"</li>
                            </ol>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('main.profile') }}" class="btn btn-outline-primary" target="_blank">
                                    <i class="fas fa-user-edit"></i> V√©rifier mon profil
                                </a>
                                <a href="{{ url_for('main.choose_type') }}" class="btn btn-info" target="_blank">
                                    <i class="fas fa-plus-circle"></i> Tester soumission HAL
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-lightbulb"></i> 
                        <strong>Astuce :</strong> Utilisez les comptes de test g√©n√©r√©s (mot de passe: <code>password123</code>) 
                        pour tester diff√©rents sc√©narios (avec/sans IDHAL, diff√©rentes affiliations, etc.)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section d'urgence -->
    <div class="row">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Zone d'urgence</h5>
                </div>
                <div class="card-body">
                    <p class="text-danger mb-3">
                        <strong>Attention :</strong> Ces actions peuvent affecter les donn√©es de production !
                    </p>
                    <div class="row">
                        <div class="col-md-6">
                            <a href="{{ url_for('admin.cleanup_test_data') }}" class="btn btn-outline-danger w-100" 
                               onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer tous les comptes de test ?')">
                                <i class="fas fa-trash-alt"></i> Supprimer tous les comptes test
                            </a>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-secondary w-100" onclick="showDatabaseInfo()">
                                <i class="fas fa-database"></i> Info base de donn√©es
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function listTestFiles() {
    alert('Fichiers g√©n√©r√©s dans static/uploads/test_pdfs/:\n\n‚Ä¢ abstract_test.pdf\n‚Ä¢ article_test.pdf\n‚Ä¢ wip_test.pdf\n‚Ä¢ poster1_test.pdf\n‚Ä¢ poster2_test.pdf');
}

function showDatabaseInfo() {
    const info = `√âtat de la base de donn√©es :

üìä Affiliations : {{ stats.affiliations }}
üë• Utilisateurs : {{ stats.users_total }}
üîç Reviewers : {{ stats.users_reviewers }}
üìù Communications : {{ stats.communications }}
üìÅ Fichiers : {{ stats.files_uploaded }}
üß™ Comptes test : {{ stats.users_test }}

Pr√™t pour les tests HAL : {{ 'Oui' if stats.affiliations > 0 and stats.users_total > 0 else 'Non' }}`;
    
    alert(info);
}
</script>
{% endblock %}
