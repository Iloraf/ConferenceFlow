<!-- templates/admin/test_zone.html - Template complet -->
{% extends "base.html" %}

{% block title %}Zone de Test - Administration{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1><i class="fas fa-flask text-warning"></i> Zone de Test</h1>
                    <p class="text-muted">Outils de d√©veloppement et de test pour {{ conference.short_name }}</p>
                </div>
                <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Retour Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Statistiques actuelles -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> √âtat actuel de la base de donn√©es</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-primary">{{ stats.affiliations }}</h3>
                                <small>Affiliations</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-success">{{ stats.users_total }}</h3>
                                <small>Utilisateurs</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-warning">{{ stats.users_reviewers }}</h3>
                                <small>Reviewers</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-info">{{ stats.communications }}</h3>
                                <small>Communications</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-secondary">{{ stats.files_uploaded }}</h3>
                                <small>Fichiers</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="text-center">
                                <h3 class="text-danger">{{ stats.users_test }}</h3>
                                <small>Comptes test</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 1: Configuration initiale -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-database"></i> 1. Configuration initiale</h5>
                </div>
                <div class="card-body">
                    <p>Pr√©parer la base de donn√©es avec les donn√©es de base.</p>
                    
                    <div class="mb-3">
                        <strong>Fichier affiliations.csv :</strong>
                        {% if file_status.affiliations_csv_exists %}
                            <span class="badge bg-success ms-2">‚úì Trouv√©</span>
                        {% else %}
                            <span class="badge bg-danger ms-2">‚úó Manquant</span>
                        {% endif %}
                        <br><small class="text-muted">{{ file_status.csv_path }}</small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('admin.import_affiliations') }}" class="btn btn-primary">
                            <i class="fas fa-upload"></i> Importer les affiliations
                        </a>
                        <a href="{{ url_for('admin.setup_status') }}" class="btn btn-outline-primary">
                            <i class="fas fa-info-circle"></i> V√©rifier le statut
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-users"></i> 2. Donn√©es de test</h5>
                </div>
                <div class="card-body">
                    <p>Cr√©er des utilisateurs et reviewers factices pour les tests.</p>
                    
                    <div class="mb-3">
                        <strong>Comptes de test actuels :</strong>
                        <span class="badge bg-info ms-2">{{ stats.users_test }} comptes</span>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('admin.generate_test_data') }}" class="btn btn-success">
                            <i class="fas fa-user-plus"></i> G√©n√©rer utilisateurs test
                        </a>
                        <a href="{{ url_for('admin.cleanup_test_data') }}" class="btn btn-outline-danger">
                            <i class="fas fa-trash"></i> Nettoyer les donn√©es test
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 2: Fichiers de test -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-file-pdf"></i> 3. Documents de test</h5>
                </div>
                <div class="card-body">
                    <p>G√©n√©rer des PDF de test pour tous les types de documents.</p>
                    
                    <div class="mb-3">
                        <strong>PDFs de test :</strong>
                        {% if file_status.test_pdfs_exist %}
                            <span class="badge bg-success ms-2">‚úì G√©n√©r√©s</span>
                        {% else %}
                            <span class="badge bg-secondary ms-2">? Non g√©n√©r√©s</span>
                        {% endif %}
                        <br><small class="text-muted">{{ file_status.pdfs_dir }}</small>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('admin.generate_test_pdfs') }}" class="btn btn-warning">
                            <i class="fas fa-file-pdf"></i> G√©n√©rer PDFs de test
                        </a>
                        {% if file_status.test_pdfs_exist %}
                        <button class="btn btn-outline-info" onclick="listTestFiles()">
                            <i class="fas fa-list"></i> Voir les fichiers g√©n√©r√©s
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-orange text-white" style="background-color: #fd7e14;">
                    <h5 class="mb-0"><i class="fas fa-vials"></i> 4. Tests fonctionnels</h5>
                </div>
                <div class="card-body">
                    <p>Tester les fonctionnalit√©s cl√©s de l'application.</p>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('main.mes_communications') }}" class="btn btn-outline-info" target="_blank">
                            <i class="fas fa-eye"></i> Voir mes communications
                        </a>
                        <a href="{{ url_for('main.choose_type') }}" class="btn btn-outline-success" target="_blank">
                            <i class="fas fa-plus"></i> Tester soumission
                        </a>
                        <a href="{{ url_for('admin.manage_users') }}" class="btn btn-outline-warning" target="_blank">
                            <i class="fas fa-users-cog"></i> Gestion utilisateurs
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 3: Tests HAL -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-archive text-info"></i> 5. Tests du syst√®me HAL</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>Workflow de test HAL recommand√© :</h6>
                            <ol class="mb-3">
                                <li>V√©rifier que vous avez un <strong>IDHAL</strong> renseign√© dans votre profil</li>
                                <li>Cr√©er une communication avec les <strong>PDFs de test</strong></li>
                                <li>V√©rifier que la <strong>case HAL est coch√©e</strong> par d√©faut</li>
                                <li>Tester les <strong>validations JavaScript</strong> (IDHAL manquant)</li>
                                <li>Voir le <strong>statut HAL</strong> dans "Mes Communications"</li>
                            </ol>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('main.profile') }}" class="btn btn-outline-primary" target="_blank">
                                    <i class="fas fa-user-edit"></i> V√©rifier mon profil
                                </a>
                                <a href="{{ url_for('main.choose_type') }}" class="btn btn-info" target="_blank">
                                    <i class="fas fa-plus-circle"></i> Tester soumission HAL
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-lightbulb"></i> 
                        <strong>Astuce :</strong> Utilisez les comptes de test g√©n√©r√©s (mot de passe: <code>password123</code>) 
                        pour tester diff√©rents sc√©narios (avec/sans IDHAL, diff√©rentes affiliations, etc.)
                    </div>
                </div>
            </div>
        </div>
    </div>


<!-- INSTRUCTION: Ajoutez cette section dans app/templates/admin/test_zone.html -->
<!-- apr√®s la section "Tests du syst√®me HAL" -->

    <!-- Section 5: Sc√©narios de Review -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card h-100 border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-tasks"></i> 5. Sc√©narios de Review Complets</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6>G√©n√©rateur de workflow de review complet :</h6>
                            <p class="text-muted mb-3">Cr√©e un environnement de test r√©aliste avec :</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="mb-3">
                                        <li><strong>3 reviewers</strong> avec sp√©cialit√©s diff√©rentes</li>
                                        <li><strong>3 auteurs</strong> pour les soumissions</li>
                                        <li><strong>4 communications</strong> avec statuts vari√©s</li>
                                        <li><strong>Documents PDF</strong> factices g√©n√©r√©s</li>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <ul class="mb-3">
                                        <li>Sc√©nario <span class="badge bg-success">ACCEPT√â</span></li>
                                        <li>Sc√©nario <span class="badge bg-warning">R√âVISION</span></li>
                                        <li>Sc√©nario <span class="badge bg-danger">REJET√â</span></li>
                                        <li>Sc√©nario <span class="badge bg-info">WIP</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('admin.generate_review_scenario') }}" class="btn btn-success">
                                    <i class="fas fa-magic"></i> Cr√©er Sc√©narios Review
                                </a>
                                <a href="{{ url_for('admin.reset_review_scenario') }}" class="btn btn-outline-danger">
                                    <i class="fas fa-trash"></i> Reset Sc√©narios
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Guide de test -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-route me-2"></i>Guide de test apr√®s g√©n√©ration :</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <strong>Pour les admins :</strong>
                                            <ol class="small">
                                                <li>Allez dans <a href="{{ url_for('admin.view_assignments') }}" target="_blank">Gestion des Reviews</a></li>
                                                <li>V√©rifiez les affectations cr√©√©es</li>
                                                <li>Testez les notifications group√©es</li>
                                                <li>Consultez les reviews termin√©es</li>
                                                <li>Testez la prise de d√©cision finale</li>
                                            </ol>
                                        </div>
                                        <div class="col-md-6">
                                            <strong>Pour les reviewers (connexion avec mot de passe <code>password123</code>) :</strong>
                                            <ul class="small">
                                                <li><strong>reviewer1@test-sft.fr</strong> - Sp√©cialiste COND/CONVECTION</li>
                                                <li><strong>reviewer2@test-sft.fr</strong> - Sp√©cialiste COMBUST/SIMUL</li>
                                                <li><strong>reviewer3@test-sft.fr</strong> - Sp√©cialiste ECHANG/POREUX</li>
                                            </ul>
                                            <p class="small text-muted">Connectez-vous avec ces comptes pour tester l'interface reviewer</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Liens de test rapide -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>üéØ Acc√®s rapide pour les tests :</h6>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('admin.view_assignments') }}" class="btn btn-outline-primary btn-sm" target="_blank">
                                    <i class="fas fa-tasks"></i> Reviews
                                </a>
                                <a href="{{ url_for('admin.send_grouped_notifications') }}" class="btn btn-outline-info btn-sm" target="_blank">
                                    <i class="fas fa-bell"></i> Notifications
                                </a>
                                <a href="{{ url_for('admin.completed_reviews') }}" class="btn btn-outline-success btn-sm" target="_blank">
                                    <i class="fas fa-check-circle"></i> Reviews termin√©es
                                </a>
                                <a href="{{ url_for('admin.communications_dashboard') }}" class="btn btn-outline-secondary btn-sm" target="_blank">
                                    <i class="fas fa-chart-line"></i> Dashboard Communications
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 6: Tests d'export -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100 border-info">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-cloud-upload-alt"></i> 6. Tests Export HAL & DOI</h5>
                </div>
                <div class="card-body">
                    <p>Tester le module d'export unifi√© apr√®s avoir cr√©√© les sc√©narios de review.</p>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Pr√©requis :</strong> Communications avec statut ACCEPT√â
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('export.dashboard') }}" class="btn btn-info" target="_blank">
                            <i class="fas fa-upload"></i> Dashboard Export HAL+DOI
                        </a>
                        <a href="{{ url_for('export.dashboard') }}" class="btn btn-outline-info" target="_blank">
                            <i class="fas fa-database"></i> Dashboard HAL uniquement
                        </a>
                    </div>
                    
                    <div class="mt-3">
                        <h6 class="small">Tests √† effectuer :</h6>
                        <ul class="small">
                            <li>G√©n√©ration automatique des DOI</li>
                            <li>Extraction des r√©sum√©s depuis PDF</li>
                            <li>Export vers HAL (mode test)</li>
                            <li>T√©l√©chargement XML DataCite</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card h-100 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-mobile-alt"></i> 7. Tests PWA & Mobile</h5>
                </div>
                <div class="card-body">
                    <p>Tester les fonctionnalit√©s PWA avec les donn√©es factices.</p>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('main.index') }}" class="btn btn-warning" target="_blank">
                            <i class="fas fa-mobile"></i> Interface utilisateur
                        </a>
                        <a href="/manifest.json" class="btn btn-outline-warning" target="_blank">
                            <i class="fas fa-file-code"></i> V√©rifier manifest.json
                        </a>
                    </div>
                    
                    <div class="mt-3">
                        <h6 class="small">√Ä v√©rifier :</h6>
                        <ul class="small">
                            <li>Manifest avec "{{ conference.short_name }}"</li>
                            <li>Installation PWA sur mobile</li>
                            <li>QR codes pour communications</li>
                            <li>Interface responsive</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    
    <!-- Section 4: Emails de test -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-envelope"></i> 6. Tests emails</h5>
                </div>
                <div class="card-body">
                    <p>Tester l'envoi des emails automatiques.</p>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('admin.send_test_email') }}" class="btn btn-secondary">
                            <i class="fas fa-paper-plane"></i> Email de test
                        </a>
                        <a href="{{ url_for('admin.send_qr_reminders') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-qrcode"></i> Rappels QR codes
                        </a>
                        <a href="{{ url_for('admin.send_grouped_notifications') }}" class="btn btn-outline-info">
                            <i class="fas fa-bell"></i> Notifications group√©es
                        </a>
                    </div>
                </div>
            </div>
        </div>






	
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="fas fa-tools"></i> 7. Outils avanc√©s</h5>
                </div>
                <div class="card-body">
                    <p>Outils pour le debugging et l'analyse.</p>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-dark" onclick="showDatabaseInfo()">
                            <i class="fas fa-database"></i> Info base de donn√©es
                        </button>
                        <a href="{{ url_for('admin.export_communications_csv') }}" class="btn btn-outline-success">
                            <i class="fas fa-download"></i> Export CSV
                        </a>
                        <button class="btn btn-outline-warning" onclick="checkSystemStatus()">
                            <i class="fas fa-heartbeat"></i> Statut syst√®me
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>




    
    <!-- Section d'urgence -->
    <div class="row">
        <div class="col-12">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle"></i> Zone d'urgence</h5>
                </div>
                <div class="card-body">
                    <p class="text-danger mb-3">
                        <strong>Attention :</strong> Ces actions peuvent affecter les donn√©es de production !
                    </p>
                    <div class="row">
                        <div class="col-md-6">
                            <a href="{{ url_for('admin.cleanup_test_data') }}" class="btn btn-outline-danger w-100" 
                               onclick="return confirm('√ätes-vous s√ªr de vouloir supprimer tous les comptes de test ?')">
                                <i class="fas fa-trash-alt"></i> Supprimer tous les comptes test
                            </a>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-secondary w-100" onclick="showDatabaseInfo()">
                                <i class="fas fa-database"></i> Info base de donn√©es
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function listTestFiles() {
    const files = [
        'abstract_test.pdf',
        'article_test.pdf', 
        'wip_test.pdf',
        'poster1_test.pdf',
        'poster2_test.pdf'
    ];
    
    alert('Fichiers g√©n√©r√©s dans static/uploads/test_pdfs/:\n\n‚Ä¢ ' + files.join('\n‚Ä¢ '));
}

function showDatabaseInfo() {
    const info = `√âtat de la base de donn√©es :

üìä Affiliations : {{ stats.affiliations }}
üë• Utilisateurs : {{ stats.users_total }}
üîç Reviewers : {{ stats.users_reviewers }}
üìù Communications : {{ stats.communications }}
üìÅ Fichiers : {{ stats.files_uploaded }}
üß™ Comptes test : {{ stats.users_test }}

Pr√™t pour les tests HAL : {{ 'Oui' if stats.affiliations > 0 and stats.users_total > 0 else 'Non' }}`;
    
    alert(info);
}

function checkSystemStatus() {
    const status = [];
    
    // V√©rification des stats
    const stats = {
        affiliations: {{ stats.affiliations }},
        users: {{ stats.users_total }},
        reviewers: {{ stats.users_reviewers }},
        communications: {{ stats.communications }}
    };
    
    if (stats.affiliations === 0) {
        status.push('‚ùå Aucune affiliation - Importez le fichier CSV');
    } else {
        status.push('‚úÖ Affiliations OK (' + stats.affiliations + ')');
    }
    
    if (stats.users === 0) {
        status.push('‚ùå Aucun utilisateur - G√©n√©rez des donn√©es test');
    } else {
        status.push('‚úÖ Utilisateurs OK (' + stats.users + ')');
    }
    
    if (stats.reviewers === 0) {
        status.push('‚ö†Ô∏è Aucun reviewer - Cr√©ez des reviewers');
    } else {
        status.push('‚úÖ Reviewers OK (' + stats.reviewers + ')');
    }
    
    status.push('üìä Communications : ' + stats.communications);
    
    // Affichage du statut
    alert('Statut du syst√®me :\n\n' + status.join('\n'));
}

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Zone de test charg√©e');
    
    // Ajout de tooltips Bootstrap si disponible
    if (typeof bootstrap !== 'undefined') {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }
});
</script>
{% endblock %}
