{% extends "base.html" %}

{% block title %}Détails Review - {{ communication.title }} - Admin {{ conference.short_name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a href="{{ url_for('admin.admin_dashboard') }}">Administration</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('admin.completed_reviews') }}">Reviews terminées</a></li>
                    <li class="breadcrumb-item active">Communication #{{ communication.id }}</li>
                </ol>
            </nav>
            <h2><i class="fas fa-file-alt"></i> {{ communication.title }}</h2>
            <p class="text-muted">{{ stats.total_reviews }} review(s) terminée(s) • Score moyen: {{ "%.1f"|format(stats.avg_score) }}/10</p>
        </div>
        <div>
            <a href="{{ url_for('admin.completed_reviews') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Retour à la liste
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Informations de la communication -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Informations</h5>
                </div>
                <div class="card-body">
                    <p><strong>ID:</strong> {{ communication.id }}</p>
                    <p><strong>Type:</strong> {{ communication.type|title }}</p>
                    <p><strong>Statut:</strong> {{ communication.status.value|title }}</p>
                    <p><strong>Créé le:</strong> {{ communication.created_at.strftime('%d/%m/%Y') }}</p>
                    
                    <h6 class="mt-3">Auteurs:</h6>
                    {% for author in communication.authors %}
                        <span class="badge bg-primary me-1">{{ author.full_name }}</span>
                    {% endfor %}
                    
                    {% if communication.thematiques %}
                    <h6 class="mt-3">Thématiques:</h6>
                    {% for thematique in communication.thematiques %}
                        <span class="badge bg-info me-1">{{ thematique.code }}</span>
                    {% endfor %}
                    {% endif %}
                </div>
            </div>

            <!-- Statistiques des reviews -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar"></i> Résumé des reviews</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h3 class="text-primary">{{ "%.1f"|format(stats.avg_score) }}/10</h3>
                        <small class="text-muted">Score moyen</small>
                    </div>
                    
                    <h6>Recommendations:</h6>
                    <div class="mb-2">
                        <span class="badge bg-success">{{ stats.recommendations.accepter }} Accepter</span>
                        <span class="badge bg-warning">{{ stats.recommendations.réviser }} Réviser</span>
                        <span class="badge bg-danger">{{ stats.recommendations.rejeter }} Rejeter</span>
                    </div>
                    
                    {% if stats.biot_fourier_count > 0 %}
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-trophy"></i>
                        <strong>{{ stats.biot_fourier_count }}</strong> nomination(s) pour le prix Biot-Fourier
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

<!-- AJOUTER cette section après les actions de décision existantes dans admin/review_details.html -->

<!-- Actions spéciales administratives -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-info">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="fas fa-tools"></i> Actions spéciales</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    
                    <!-- Conversion Article → WIP -->
                    {% if communication.type == 'article' and communication.status != 'accepté' %}
                    <div class="col-md-6">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0"><i class="fas fa-exchange-alt"></i> Convertir en WIP</h6>
                            </div>
                            <div class="card-body">
                                <p class="small text-muted mb-3">
                                    Convertit cet article en Work in Progress. Cette action :
                                    <br>• Change le type de la communication
                                    <br>• Supprime le résumé anglais
                                    <br>• Peut conserver ou supprimer les reviews
                                    <br>• Notifie les auteurs
                                </p>
                                
                                <button type="button" class="btn btn-warning btn-sm w-100" 
                                        data-bs-toggle="modal" data-bs-target="#convertToWipModal">
                                    <i class="fas fa-exchange-alt"></i> Convertir en WIP
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <!-- Marquage pour le prix -->
                    {% if communication.status.value == 'accepté' %}
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0"><i class="fas fa-award"></i> Prix de la conférence</h6>
                            </div>
                            <div class="card-body">
                                <p class="small text-muted mb-3">
                                    {% if communication.prix %}
                                        <span class="badge bg-success">✓ Marquée pour le prix</span>
                                        <br>Cette communication est marquée comme candidate au prix de la conférence.
                                    {% else %}
                                        Marquer cette communication comme candidate au prix de la conférence.
                                    {% endif %}
                                </p>
                                
                                <form method="POST" action="{{ url_for('admin.toggle_communication_prix', comm_id=communication.id) }}" style="display: inline;">
                                    <button type="submit" class="btn btn-sm w-100 
                                        {{ 'btn-outline-success' if communication.prix else 'btn-success' }}"
                                        onclick="return confirm('{{ 'Retirer cette communication du concours pour le prix ?' if communication.prix else 'Marquer cette communication pour le prix de la conférence ?' }}')">
                                        <i class="fas fa-{{ 'minus' if communication.prix else 'award' }}"></i>
                                        {{ 'Retirer du prix' if communication.prix else 'Marquer pour le prix' }}
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                </div>
                
                <!-- Actions générales -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="btn-group w-100" role="group">
                            <a href="{{ url_for('admin.communication_details', comm_id=communication.id) }}" 
                               class="btn btn-outline-primary">
                                <i class="fas fa-eye"></i> Voir détails complets
                            </a>
                            
                            <a href="{{ url_for('admin.communications_list') }}" 
                               class="btn btn-outline-secondary">
                                <i class="fas fa-list"></i> Retour à la liste
                            </a>
                            
                            {% if communication.abstract_fr or communication.abstract_en %}
                            <button type="button" class="btn btn-outline-info" 
                                    data-bs-toggle="modal" data-bs-target="#viewAbstractModal">
                                <i class="fas fa-file-text"></i> Voir résumés
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour la conversion Article → WIP -->
{% if communication.type == 'article' and communication.status != 'accepté' %}
<div class="modal fade" id="convertToWipModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt"></i> Convertir l'article en Work in Progress
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.convert_article_to_wip', comm_id=communication.id) }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>Attention :</strong> Cette action est irréversible et va :
                        <ul class="mb-0 mt-2">
                            <li>Changer le type de "Article" vers "Work in Progress"</li>
                            <li>Supprimer le résumé anglais (les WIP n'en ont pas)</li>
                            <li>Remettre le statut à "WIP soumis"</li>
                            <li>Annuler toute décision prise</li>
                            <li>Notifier les auteurs du changement</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reason" class="form-label">Raison de la conversion <span class="text-muted">(optionnel)</span></label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" 
                                  placeholder="Ex: Travaux encore préliminaires, pas assez de résultats pour un article complet..."></textarea>
                        <div class="form-text">Cette raison sera communiquée aux auteurs dans l'email de notification.</div>
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="keep_reviews" name="keep_reviews" value="1">
                        <label class="form-check-label" for="keep_reviews">
                            Conserver les reviews existantes
                        </label>
                        <div class="form-text">
                            Si décoché, toutes les reviews et assignations seront supprimées.
                            Si coché, les reviews resteront visibles dans l'historique.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-exchange-alt"></i> Confirmer la conversion
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal pour voir les résumés -->
{% if communication.abstract_fr or communication.abstract_en %}
<div class="modal fade" id="viewAbstractModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-text"></i> Résumés - {{ communication.title }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if communication.abstract_fr %}
                <div class="mb-4">
                    <h6><i class="fas fa-flag"></i> Résumé en français</h6>
                    <div class="border rounded p-3 bg-light">
                        {{ communication.abstract_fr|nl2br }}
                    </div>
                    <small class="text-muted">{{ communication.abstract_fr|length }} caractères</small>
                </div>
                {% endif %}
                
                {% if communication.abstract_en %}
                <div class="mb-4">
                    <h6><i class="fas fa-flag"></i> Résumé en anglais</h6>
                    <div class="border rounded p-3 bg-light">
                        {{ communication.abstract_en|nl2br }}
                    </div>
                    <small class="text-muted">{{ communication.abstract_en|length }} caractères</small>
                </div>
                {% endif %}
                
                {% if communication.keywords %}
                <div class="mb-3">
                    <h6><i class="fas fa-tags"></i> Mots-clés</h6>
                    <div class="border rounded p-2 bg-light">
                        {{ communication.keywords }}
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

	
        <!-- Reviews détaillées -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-comments"></i> Reviews détaillées</h5>
                </div>
                <div class="card-body">
                    {% for review in reviews %}
                    <div class="card mb-3 border-{% if review.recommendation.value == 'accepter' %}success{% elif review.recommendation.value == 'rejeter' %}danger{% else %}warning{% endif %}">
                        <div class="card-header">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h6 class="mb-0">Review {{ loop.index }}</h6>
                                    <small class="text-muted">Soumise le {{ review.submitted_at.strftime('%d/%m/%Y à %H:%M') if review.submitted_at else 'N/A' }}</small>
                                </div>
                                <div class="col-md-6 text-end">
                                    <span class="badge bg-primary">Score: {{ review.score or 'N/A' }}/10</span>
                                    {% if review.recommendation %}
                                        <span class="badge bg-{% if review.recommendation.value == 'accepter' %}success{% elif review.recommendation.value == 'rejeter' %}danger{% else %}warning{% endif %}">
                                            {{ review.recommendation.value|title }}
                                        </span>
                                    {% endif %}
                                    {% if review.recommend_for_biot_fourier %}
                                        <span class="badge bg-warning"><i class="fas fa-trophy"></i> Biot-Fourier</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if review.comments_for_authors %}
                            <h6><i class="fas fa-users"></i> Commentaires pour les auteurs:</h6>
                            <div class="bg-light p-3 rounded mb-3">
                                {{ review.comments_for_authors|nl2br }}
                            </div>
                            {% endif %}
                            
                            {% if review.comments_for_committee %}
                            <h6><i class="fas fa-user-shield"></i> Commentaires pour le comité:</h6>
                            <div class="bg-warning bg-opacity-10 p-3 rounded">
                                {{ review.comments_for_committee|nl2br }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Actions en bas -->



<!-- Étape 4 : Remplacez la section "Actions en bas" dans review_details.html -->

<!-- Actions en bas -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tools"></i> Actions administratives</h5>
            </div>
            <div class="card-body">
                {% if communication.can_make_decision() %}
                    <!-- Formulaire pour les décisions -->
                    <form id="decisionForm" method="POST" action="{{ url_for('admin.make_communication_decision', comm_id=communication.id) }}">
                        
                        <!-- Zone de commentaires -->
                        <div class="mb-3">
                            <label for="comments" class="form-label">Commentaires pour la décision (optionnel) :</label>
                            <textarea class="form-control" id="comments" name="comments" rows="3" 
                                    placeholder="Commentaires sur la décision ou instructions pour les auteurs..."></textarea>
                        </div>
                        
                        <!-- Boutons de décision -->
                        <div class="row">
                            <div class="col-md-4">
                                <button type="button" class="btn btn-success w-100" onclick="submitDecision('accepter')">
                                    <i class="fas fa-check"></i> Accepter la communication
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-warning w-100" onclick="submitDecision('reviser')">
                                    <i class="fas fa-edit"></i> Demander des révisions
                                </button>
                            </div>
                            <div class="col-md-4">
                                <button type="button" class="btn btn-danger w-100" onclick="submitDecision('rejeter')">
                                    <i class="fas fa-times"></i> Rejeter la communication
                                </button>
                            </div>
                        </div>
                        
                        <!-- Champ caché pour la décision -->
                        <input type="hidden" id="decision" name="decision" value="">
                    </form>
                    
                    <!-- Alertes de confirmation -->
                    <div id="confirmationAlert" class="alert alert-info mt-3" style="display: none;">
                        <div id="confirmationText"></div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-secondary btn-sm me-2" onclick="cancelDecision()">Annuler</button>
                            <button type="button" class="btn btn-primary btn-sm" onclick="confirmDecision()">Confirmer</button>
                        </div>
                    </div>
                
                {% else %}
                    <!-- Communication déjà décidée -->
<!-- Communication déjà décidée -->
<!-- Communication déjà décidée -->
{% set decision_status = communication.get_decision_status_display() %}
<div class="alert alert-{{ decision_status.class }}">
    <div class="row">
        <div class="col-md-8">
            <h6 class="mb-1">
                <i class="fas fa-gavel"></i> Décision prise : {{ decision_status.text }}
            </h6>
            {% if communication.decision_date %}
                <small class="text-muted">
                    Le {{ communication.decision_date.strftime('%d/%m/%Y à %H:%M') }}
                    {% if communication.decision_by %}
                        par {{ communication.decision_by.full_name }}
                    {% endif %}
                </small>
            {% endif %}
            
            {% if communication.decision_comments %}
                <div class="mt-2">
                    <strong>Commentaires de l'admin :</strong><br>
                    {{ communication.decision_comments|nl2br }}
                </div>
            {% endif %}
            
            <!-- Afficher les commentaires des reviewers pour les révisions -->
            {% if communication.final_decision == 'reviser' and reviews %}
                <div class="mt-3">
                    <h6><i class="fas fa-comments"></i> Retours des reviewers (à transmettre aux auteurs) :</h6>
                    {% for review in reviews %}
                        {% if review.comments_for_authors %}
                            <div class="border-start border-3 border-info ps-3 mb-2 bg-light p-2">
                                <small class="text-muted"><strong>Reviewer {{ loop.index }} :</strong></small><br>
                                {{ review.comments_for_authors|nl2br }}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
        </div>
        
        <div class="col-md-4">
            <!-- État de la notification -->
            <div class="mb-2">
                {% if communication.decision_notification_sent %}
                    <span class="badge bg-success"><i class="fas fa-check"></i> Notification envoyée</span><br>
                    <small class="text-muted">
                        Le {{ communication.decision_notification_sent_at.strftime('%d/%m/%Y à %H:%M') if communication.decision_notification_sent_at }}
                    </small>
                {% elif communication.decision_notification_error %}
                    <span class="badge bg-danger"><i class="fas fa-exclamation-triangle"></i> Erreur d'envoi</span><br>
                    <small class="text-danger">{{ communication.decision_notification_error }}</small>
                {% else %}
                    <span class="badge bg-warning"><i class="fas fa-envelope"></i> Notification pas encore envoyée</span>
                {% endif %}
            </div>
            
            <!-- Actions -->
            <div class="d-grid gap-1">
                <!-- Bouton pour envoyer la notification -->
                {% if not communication.decision_notification_sent %}
                    <form method="POST" action="{{ url_for('admin.send_decision_notification', comm_id=communication.id) }}" 
                          onsubmit="return confirm('Envoyer la notification à tous les auteurs ?')" 
                          style="display: inline;">
                        <button type="submit" class="btn btn-primary btn-sm w-100">
                            <i class="fas fa-envelope"></i> Envoyer notification
                        </button>
                    </form>
                {% else %}
                    <button class="btn btn-outline-primary btn-sm w-100" disabled>
                        <i class="fas fa-check"></i> Notification envoyée
                    </button>
                {% endif %}
                
                <!-- Bouton pour modifier la décision -->
                <form method="POST" action="{{ url_for('admin.reset_communication_decision', comm_id=communication.id) }}" 
                      onsubmit="return confirm('Êtes-vous sûr de vouloir annuler cette décision ?')" 
                      style="display: inline;">
                    <button type="submit" class="btn btn-outline-secondary btn-sm w-100">
                        <i class="fas fa-undo"></i> Modifier la décision
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

                
                <!-- Actions secondaires -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary w-100">
                            <i class="fas fa-envelope"></i> Envoyer feedback aux auteurs
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button class="btn btn-outline-info w-100">
                            <i class="fas fa-download"></i> Exporter le rapport complet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript pour la confirmation -->
<script>
let pendingDecision = null;

function submitDecision(decision) {
    const decisionTexts = {
        'accepter': 'Accepter cette communication',
        'rejeter': 'Rejeter cette communication', 
        'reviser': 'Demander des révisions pour cette communication'
    };
    
    pendingDecision = decision;
    document.getElementById('decision').value = decision;
    
    const alertElement = document.getElementById('confirmationAlert');
    const textElement = document.getElementById('confirmationText');
    
    textElement.innerHTML = `
        <strong>Confirmation :</strong> Êtes-vous sûr de vouloir <strong>${decisionTexts[decision]}</strong> ?
        <br><small class="text-muted">Cette action modifiera le statut de la communication.</small>
    `;
    
    alertElement.style.display = 'block';
    alertElement.scrollIntoView({behavior: 'smooth'});
}

function cancelDecision() {
    pendingDecision = null;
    document.getElementById('decision').value = '';
    document.getElementById('confirmationAlert').style.display = 'none';
}

function confirmDecision() {
    if (pendingDecision) {
        document.getElementById('decisionForm').submit();
    }
}
</script>


</div>
{% endblock %}
