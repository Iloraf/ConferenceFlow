{% extends 'base.html' %}

{% block title %}Import des reviewers{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- En-tête -->
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="{{ url_for('admin.admin_dashboard') }}">Administration</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('admin.manage_users') }}">Utilisateurs</a></li>
                <li class="breadcrumb-item active">Import reviewers</li>
            </ol>
        </nav>
        <h1 class="h2 text-primary">
            <i class="fas fa-upload me-2"></i>Import des reviewers
        </h1>
        <p class="text-muted">Promouvoir des utilisateurs existants en tant que reviewers via un fichier CSV</p>
    </div>

    <div class="row">
        <div class="col-md-8">
            <!-- Formulaire d'upload -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-csv me-2"></i>Téléverser un fichier CSV
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" enctype="multipart/form-data" id="uploadForm">
                        <div class="mb-3">
                            <label for="csv_file" class="form-label">Fichier CSV des reviewers</label>
                            <input type="file" class="form-control" id="csv_file" name="csv_file" 
                                   accept=".csv" required>
                            <div class="form-text">
                                Le fichier doit contenir une liste d'emails d'utilisateurs existants
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <h6 class="alert-heading">
                                <i class="fas fa-info-circle me-2"></i>Informations importantes
                            </h6>
                            <ul class="mb-0">
                                <li>Les utilisateurs doivent <strong>déjà exister</strong> dans la base de données</li>
                                <li>Seuls les emails valides et existants seront promus</li>
                                <li>Le fichier doit contenir <strong>un email par ligne</strong></li>
                                <li>L'encodage du fichier doit être <strong>UTF-8</strong></li>
                            </ul>
                        </div>
                        
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-upload me-2"></i>Importer les reviewers
                        </button>
                        <a href="{{ url_for('admin.manage_users') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Retour aux utilisateurs
                        </a>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <!-- Statistiques -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Statistiques actuelles</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Reviewers actuels :</span>
                        <strong class="text-success">{{ users.filter_by(is_reviewer=True).count() if users else 0 }}</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Utilisateurs total :</span>
                        <strong class="text-primary">{{ users.count() if users else 0 }}</strong>
                    </div>
                </div>
            </div>
            
            <!-- Format CSV attendu -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Format CSV requis</h6>
                </div>
                <div class="card-body">
                    <p class="small mb-3">
                        Le fichier CSV doit contenir <strong>un email par ligne</strong>, sans en-tête :
                    </p>
                    
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary" onclick="downloadTemplate()">
                            <i class="fas fa-download me-1"></i>Télécharger un modèle
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Exemple de format -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-eye me-2"></i>Exemple de format CSV
                    </h6>
                </div>
                <div class="card-body">
                    <pre class="bg-light p-3 small rounded"><code>user1@example.com
user2@example.com
reviewer@university.edu
scientist@lab.org</code></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Gestion du formulaire d'upload
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    const fileInput = document.getElementById('csv_file');
    
    if (!fileInput.files.length) {
        e.preventDefault();
        alert('Veuillez sélectionner un fichier CSV.');
        return;
    }
    
    // Affichage du loading
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Import en cours...';
    submitBtn.disabled = true;
});

// Téléchargement du modèle CSV
function downloadTemplate() {
    const csvContent = "user1@example.com\nuser2@example.com\nreviewer@university.edu\nscientist@lab.org";
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'modele_reviewers.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Validation du fichier
document.getElementById('csv_file').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        if (!file.name.toLowerCase().endsWith('.csv')) {
            alert('Veuillez sélectionner un fichier CSV.');
            this.value = '';
            return;
        }
        
        if (file.size > 2 * 1024 * 1024) { // 2MB
            alert('Le fichier est trop volumineux (max 2MB).');
            this.value = '';
            return;
        }
    }
});
</script>
{% endblock %}
