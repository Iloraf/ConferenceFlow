{% extends 'base.html' %}

{% block title %}{{ comm.title }} - {{ conference.short_name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card shadow">
            <div class="card-header bg-info text-white">
                <h4><i class="fas fa-file-text me-2"></i>{{ comm.title }}</h4>
            </div>
            <div class="card-body">
<!-- Bouton pour modifier la communication (si auteur principal) -->
                {% if comm.authors and comm.authors[0].id == current_user.id %}
                    {% if comm.status not in [CommunicationStatus.EN_REVIEW, CommunicationStatus.ARTICLE_ACCEPTE, CommunicationStatus.ARTICLE_ACCEPTE_SOUS_RESERVE] %}
                        <div class="alert alert-light border mb-3">
                            <a href="{{ url_for('main.edit_communication', comm_id=comm.id) }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-edit me-2"></i>Modifier le titre et ajouter des co-auteurs
                            </a>
                        </div>
                    {% endif %}
                {% endif %}


	      <!-- Informations -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <p><strong>Type :</strong> 
                            <span class="badge bg-{{ 'danger' if comm.type == 'article' else 'warning' }}">
                                {{ 'Article complet' if comm.type == 'article' else 'Work in Progress' }}
                            </span>
                        </p>
                        <p><strong>Statut :</strong> 
                            <span class="badge bg-{{ 'success' if comm.status.value == 'accepté' else 'danger' if comm.status.value == 'rejeté' else 'warning' if 'review' in comm.status.value else 'primary' }}">
                                {{ comm.status.value.replace('_', ' ').title() }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Créé le :</strong> {{ comm.created_at.strftime('%d/%m/%Y %H:%M') }}</p>
                        <p><strong>Modifié le :</strong> {{ comm.updated_at.strftime('%d/%m/%Y %H:%M') }}</p>
                    </div>
                </div>
                

<!-- Workflow et prochaines étapes -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="fas fa-route me-2"></i>Workflow et prochaines étapes</h5>
    </div>
    <div class="card-body">
        {% if comm.type == 'article' %}
            <!-- Workflow Article -->
            <div class="row text-center mb-3">
                <div class="col">
                    <div class="badge bg-{{ 'success' if comm.status.value in ['résumé_soumis', 'article_soumis', 'en_review', 'accepté', 'poster_soumis'] else 'secondary' }} p-2 w-100">
                        1. Résumé
                    </div>
                </div>
                <div class="col">
                    <i class="fas fa-arrow-right text-muted"></i>
                </div>
                <div class="col">
                    <div class="badge bg-{{ 'success' if comm.status.value in ['article_soumis', 'en_review', 'accepté', 'poster_soumis'] else 'warning' if comm.status.value == 'résumé_soumis' else 'secondary' }} p-2 w-100">
                        2. Article
                    </div>
                </div>
                <div class="col">
                    <i class="fas fa-arrow-right text-muted"></i>
                </div>
                <div class="col">
                    <div class="badge bg-{{ 'success' if comm.status.value in ['en_review', 'accepté', 'poster_soumis'] else 'secondary' }} p-2 w-100">
                        3. Review
                    </div>
                </div>
                <div class="col">
                    <i class="fas fa-arrow-right text-muted"></i>
                </div>
                <div class="col">
                    <div class="badge bg-{{ 'success' if comm.status.value == 'poster_soumis' else 'warning' if comm.status.value == 'accepté' else 'secondary' }} p-2 w-100">
                        4. Poster
                    </div>
                </div>
            </div>
            
            <!-- Action requise -->
            <div class="alert alert-{{ 'success' if comm.status.value == 'poster_soumis' else 'warning' if comm.status.value == 'accepté' else 'info' }}">
                <i class="fas fa-{{ 'check-circle' if comm.status.value == 'poster_soumis' else 'clock' }} me-2"></i>
                <strong>
                    {% if comm.status.value == 'résumé_soumis' %}
                        Prochaine étape : Soumettre l'article complet
                    {% elif comm.status.value == 'article_soumis' %}
                        En attente : Attribution des reviewers
                    {% elif comm.status.value == 'en_review' %}
                        En cours : Review par les relecteurs
                    {% elif comm.status.value == 'accepté' %}
                        Prochaine étape : Soumettre le poster de présentation
                    {% elif comm.status.value == 'poster_soumis' %}
                        Communication complète - Prêt pour la conférence !
                    {% elif comm.status.value == 'rejeté' %}
                        Communication rejetée après review
                    {% endif %}
                </strong>
                
                {% if comm.status.value == 'résumé_soumis' %}
                    <br>Vous pouvez maintenant uploader votre article complet (format PDF).
                {% elif comm.status.value == 'accepté' %}
                    <br>Votre article a été accepté ! Préparez maintenant votre poster pour la présentation.
                {% endif %}
            </div>
            
        {% elif comm.type == 'wip' %}
            <!-- Workflow WIP -->
            <div class="row text-center mb-3">
                <div class="col">
                    <div class="badge bg-{{ 'success' if comm.status.value in ['wip_soumis', 'poster_soumis'] else 'secondary' }} p-2 w-100">
                        1. Work in Progress
                    </div>
                </div>
                <div class="col">
                    <i class="fas fa-arrow-right text-muted"></i>
                </div>
                <div class="col">
                    <div class="badge bg-{{ 'success' if comm.status.value == 'poster_soumis' else 'warning' if comm.status.value == 'wip_soumis' else 'secondary' }} p-2 w-100">
                        2. Poster
                    </div>
                </div>
            </div>
            
            <!-- Action requise -->
            <div class="alert alert-{{ 'success' if comm.status.value == 'poster_soumis' else 'info' }}">
                <i class="fas fa-{{ 'check-circle' if comm.status.value == 'poster_soumis' else 'clock' }} me-2"></i>
                <strong>
                    {% if comm.status.value == 'wip_soumis' %}
                        Prochaine étape : Soumettre le poster de présentation
                    {% elif comm.status.value == 'poster_soumis' %}
                        Communication complète - Prêt pour la conférence !
                    {% endif %}
                </strong>
                
                {% if comm.status.value == 'wip_soumis' %}
                    <br>Votre WIP est validé. Préparez maintenant votre poster pour la présentation.
                {% endif %}
            </div>
        {% endif %}
    </div>
</div>



<!-- Section Co-auteurs avec bouton de renvoi d'invitation -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">
            <i class="fas fa-users me-2"></i>Co-auteurs
        </h5>
    </div>
    <div class="card-body">
        {% if comm.authors|length > 1 %}
            <ul class="list-group list-group-flush">
                {% for author in comm.authors %}
                    {% if author.id != current_user.id %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <strong class="me-2">{{ author.full_name or author.email }}</strong>
                                        
                                        <!-- Badge auteur correspondant -->
                                        {% if comm.corresponding_author and comm.corresponding_author.id == author.id %}
                                            <span class="badge bg-primary">
                                                <i class="fas fa-envelope"></i> Auteur correspondant
                                            </span>
                                        {% endif %}
                                        
                                        <!-- Statut d'activation -->
                                        {% if author.is_activated %}
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle"></i> Compte activé
                                            </span>
                                        {% else %}
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock"></i> En attente d'activation
                                            </span>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Email -->
                                    {% if author.email %}
                                        <small class="text-muted d-block">
                                            <i class="fas fa-envelope me-1"></i>{{ author.email }}
                                        </small>
                                    {% endif %}
                                    
                                    <!-- Date d'envoi de l'invitation -->
                                    {% if not author.is_activated and author.activation_sent_at %}
                                        <small class="text-muted d-block mt-1">
                                            <i class="fas fa-paper-plane me-1"></i>
                                            Invitation envoyée le {{ author.activation_sent_at.strftime('%d/%m/%Y à %H:%M') }}
                                            
                                            <!-- Calculer si le lien a expiré (7 jours) -->
                                            {% set days_since_sent = (now - author.activation_sent_at).days %}
                                            {% if days_since_sent >= 7 %}
                                                <span class="badge bg-danger ms-2">
                                                    <i class="fas fa-exclamation-triangle"></i> Lien expiré
                                                </span>
                                            {% elif days_since_sent >= 5 %}
                                                <span class="badge bg-warning text-dark ms-2">
                                                    <i class="fas fa-hourglass-end"></i> Expire bientôt
                                                </span>
                                            {% endif %}
                                        </small>
                                    {% endif %}
                                    
                                    <!-- Affiliations -->
                                    {% if author.affiliations %}
                                        <div class="mt-2">
                                            <small class="text-muted">Affiliations :</small>
                                            {% for aff in author.affiliations %}
                                                <span class="badge bg-info text-dark me-1">{{ aff.sigle }}</span>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Bouton renvoyer invitation (uniquement pour auteur principal/correspondant) -->
                                {% set is_main_author = comm.authors[0].id == current_user.id %}
                                {% set is_corresponding = comm.corresponding_author and comm.corresponding_author.id == current_user.id %}
                                
                                {% if not author.is_activated and (is_main_author or is_corresponding) %}
                                    <div class="ms-3">
                                        <form method="POST" 
                                              action="{{ url_for('main.resend_coauthor_invitation', comm_id=comm.id, coauthor_id=author.id) }}" 
                                              class="d-inline"
                                              onsubmit="return confirm('Renvoyer l\'invitation à {{ author.full_name or author.email }} ?\n\nUn nouveau lien d\'activation valable 7 jours sera envoyé par email.');">
                                            <button type="submit" class="btn btn-sm btn-outline-primary" title="Renvoyer l'invitation">
                                                <i class="fas fa-paper-plane me-1"></i>Renvoyer l'invitation
                                            </button>
                                        </form>
                                    </div>
                                {% endif %}
                            </div>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
            
            <!-- Aide contextuelle -->
            {% set is_main_author = comm.authors[0].id == current_user.id %}
            {% set is_corresponding = comm.corresponding_author and comm.corresponding_author.id == current_user.id %}
            {% if is_main_author or is_corresponding %}
                <div class="alert alert-info mt-3 mb-0">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Info :</strong> Vous pouvez renvoyer une invitation à un co-auteur qui n'a pas encore activé son compte. 
                        Le lien d'activation est valable 7 jours.
                    </small>
                </div>
            {% endif %}
        {% else %}
            <p class="text-muted mb-0">
                <i class="fas fa-info-circle me-1"></i>Aucun co-auteur pour cette communication
            </p>
        {% endif %}
    </div>
</div>


<!-- Section Résumés ->




<!-- Section Résumés -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h6 class="mb-0"><i class="fas fa-file-text"></i> Résumés</h6>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('main.update_abstracts', comm_id=comm.id) }}">
            
            <!-- Résumé français -->
            <div class="mb-3">
                <label for="abstract_fr" class="form-label fw-bold">
                    {{ 'Résumé en français' if comm.type == 'article' else 'Work in Progress - Résumé' }} *
                </label>
                <textarea class="form-control" id="abstract_fr" name="abstract_fr" rows="6" 
                          maxlength="{{ 3000 if comm.type == 'article' else 2000 }}" required>{{ comm.abstract_fr or '' }}</textarea>
                <div class="form-text">
                    Maximum {{ 3000 if comm.type == 'article' else 2000 }} caractères.
                    <span id="count-fr" class="float-end text-muted">{{ (comm.abstract_fr|length) if comm.abstract_fr else 0 }}/{{ 3000 if comm.type == 'article' else 2000 }}</span>
                </div>
            </div>
            
            {% if comm.type == 'article' %}
            <!-- Résumé anglais pour les articles -->
            <div class="mb-3">
                <label for="abstract_en" class="form-label fw-bold">
                    Résumé en anglais <span class="text-muted">(optionnel)</span>
                </label>
                <textarea class="form-control" id="abstract_en" name="abstract_en" rows="6" 
                          maxlength="3000">{{ comm.abstract_en or '' }}</textarea>
                <div class="form-text">
                    Optionnel. Maximum 3000 caractères.
                    <span id="count-en" class="float-end text-muted">{{ (comm.abstract_en|length) if comm.abstract_en else 0 }}/3000</span>
                </div>
            </div>
            {% endif %}
            
            <!-- Mots-clés -->
            <div class="mb-3">
                <label for="keywords" class="form-label fw-bold">Mots-clés</label>
                <input type="text" class="form-control" id="keywords" name="keywords" 
                       value="{{ comm.keywords or '' }}" maxlength="500">
                <div class="form-text">
                    Séparez par des virgules. Maximum 500 caractères.
                    <span id="count-keywords" class="float-end text-muted">{{ (comm.keywords|length) if comm.keywords else 0 }}/500</span>
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Sauvegarder les résumés
            </button>
        </form>
    </div>
</div>

<script>
// Compteurs de caractères
document.addEventListener('DOMContentLoaded', function() {
    const abstractFr = document.getElementById('abstract_fr');
    const countFr = document.getElementById('count-fr');
    const maxFr = {{ 3000 if comm.type == 'article' else 2000 }};
    
    abstractFr.addEventListener('input', function() {
        const count = this.value.length;
        countFr.textContent = count + '/' + maxFr;
        countFr.className = count > maxFr ? 'float-end text-danger' : 'float-end text-muted';
    });
    
    {% if comm.type == 'article' %}
    const abstractEn = document.getElementById('abstract_en');
    const countEn = document.getElementById('count-en');
    
    abstractEn.addEventListener('input', function() {
        const count = this.value.length;
        countEn.textContent = count + '/3000';
        countEn.className = count > 3000 ? 'float-end text-danger' : 'float-end text-muted';
    });
    {% endif %}
    
    const keywords = document.getElementById('keywords');
    const countKeywords = document.getElementById('count-keywords');
    
    keywords.addEventListener('input', function() {
        const count = this.value.length;
        countKeywords.textContent = count + '/500';
        countKeywords.className = count > 500 ? 'float-end text-danger' : 'float-end text-muted';
    });
});
</script>

		
                <!-- Upload nouveau fichier -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Ajouter un fichier</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data">
                            <div class="row align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label">Type de fichier</label>
                                    <select class="form-select" name="file_type" required>
                                        <option value="">Choisir...</option>
                                        
                                        {% if comm.type == 'article' %}
                                            <option value="article" {% if not allowed_uploads.get('article') %}disabled{% endif %}>
                                                Article complet {% if not allowed_uploads.get('article') %}(non autorisé){% endif %}
                                            </option>
                                            <option value="poster" {% if not allowed_uploads.get('poster') %}disabled{% endif %}>
                                                Poster {% if not allowed_uploads.get('poster') %}(non autorisé){% endif %}
                                            </option>
                                        {% elif comm.type == 'wip' %}
                                            <option value="poster" {% if not allowed_uploads.get('poster') %}disabled{% endif %}>
                                                Poster {% if not allowed_uploads.get('poster') %}(non autorisé){% endif %}
                                            </option>
                                        {% endif %}
                                    </select>
                                    <small class="form-text text-muted">
                                        {% if comm.type == 'article' and comm.status.value == 'résumé_soumis' %}
                                            Vous pouvez maintenant soumettre l'article complet
                                        {% elif comm.type == 'article' and comm.status.value == 'accepté' %}
                                            Vous pouvez maintenant soumettre le poster
                                        {% elif comm.type == 'wip' and comm.status.value == 'wip_soumis' %}
                                            Vous pouvez maintenant soumettre le poster
                                        {% endif %}
                                    </small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Fichier (PDF uniquement)</label>
                                    <input type="file" class="form-control" name="file" required accept=".pdf">
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Historique des fichiers -->
                <h5>Fichiers soumis</h5>
                <div class="row">
                    {% for file_type, files in files_by_type.items() %}
                    {% if files %}
                    <div class="col-md-4 mb-3">
                        <div class="card">
                            <div class="card-header bg-{{ 'success' if file_type == 'résumé' else 'danger' if file_type == 'article' else 'warning' if file_type == 'wip' else 'info' }} text-white">
                                <i class="fas {{ 'fa-file-text' if file_type == 'résumé' else 'fa-file-pdf' if file_type == 'article' else 'fa-flask' if file_type == 'wip' else 'fa-image' }} me-2"></i>
                                {{ file_type.title() }}
                            </div>
                            <div class="card-body p-0">
                                <div class="list-group list-group-flush">
                                    {% for file in files %}
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                              <strong>Version {{ file.version }}</strong>
					      <br><small class="text-muted">{{ file.filename }}</small>
                                                <br><small class="text-muted">{{ file.upload_date.strftime('%d/%m %H:%M') }}</small>
                                            </div>
<a href="{{ url_for('main.download_file', file_id=file.id, renamed=1) }}" 
   class="btn btn-sm btn-outline-secondary">
    <i class="fas fa-tag"></i> {{ file.filename }}
</a>

                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                
                <!-- Workflow info -->
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Workflow :</strong>
                    {% if comm.type == 'article' %}
                        Résumé → Article complet → Review → (Si accepté) Poster
                    {% elif comm.type == 'wip' %}
                        Work in Progress → Poster
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panneau latéral -->
    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="mb-0">Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('main.mes_communications') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Retour à mes soumissions
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Statut review (seulement pour les articles) -->
        {% if comm.type == 'article' and comm.reviews %}
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">Reviews</h5>
            </div>
            <div class="card-body">
                {% for review in comm.reviews %}
                <div class="mb-2">
                    <span class="badge bg-{{ 'success' if review.recommendation == 'accept' else 'danger' if review.recommendation == 'reject' else 'warning' }}">
                        {{ review.recommendation }}
                    </span>
                    <small class="text-muted">Score: {{ review.score }}/5</small>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}




