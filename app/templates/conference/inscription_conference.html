{% extends 'base.html' %}

{% block title %}Inscription Conférence - {{ conference.short_name }}{% endblock %}

{% block extra_css %}
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4"><i class="fas fa-ticket me-2"></i>Inscription à la conférence</h1>
        
        <!-- Alerte Early Bird -->
        <div class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
            <i class="fas fa-clock me-2"></i>
            <strong>Tarif préférentiel jusqu'au {{ fees.early.date }} !</strong> 
            Économisez jusqu'à {{ fees.early_savings | default('100') }}€ en vous inscrivant maintenant.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- Tarifs -->
        <h2 class="mb-4">Tarifs d'inscription</h2>
        
        <!-- Early Bird -->
        <div class="mb-5">
            <h3 class="text-success mb-3">
                <i class="fas fa-tag me-2"></i>Tarif préférentiel (Avant le {{ fees.early.date }})
            </h3>
            <div class="row">
              <div class="col-md-3 mb-4">
                <div class="price-header early-bird text-center">
                  <h4>{{ fees.categories.student }}</h4>
                  <div class="price-amount">{{ fees.early.student }}€</div>
                </div>
              </div>
              <div class="col-md-3 mb-4">
                <div class="price-header early-bird text-center">
                  <h4>{{ fees.categories.member_individual }}</h4>
                  <div class="price-amount">{{ fees.early.member_indiv }}€</div>
                </div>
              </div>
              <div class="col-md-3 mb-4">
                <div class="price-header early-bird text-center">
                  <h4>{{ fees.categories.member_collective }}</h4>
                  <div class="price-amount">{{ fees.early.member_collec }}€</div>
                </div>
              </div>
              <div class="col-md-3 mb-4">
                <div class="price-header early-bird text-center">
                  <h4>{{ fees.categories.non_member }}</h4>
                  <div class="price-amount">{{ fees.early.not_member }}€</div>
                </div>
              </div>
            </div>
        </div>
        
        <!-- Tarif normal -->
        <div class="mb-5">
            <h3 class="text-primary mb-3">
                <i class="fas fa-calendar me-2"></i>Tarif normal (Après le {{ fees.regular.date }})
            </h3>
            <div class="row">
              <div class="col-md-3 mb-4">
                <div class="price-header regular-price text-center">
                  <h4>{{ fees.categories.student }}</h4>
                  <div class="price-amount">{{ fees.regular.student }}€</div>
                </div>
              </div>
              <div class="col-md-3 mb-4">
                <div class="price-header regular-price text-center">
                  <h4>{{ fees.categories.member_individual }}</h4>
                  <div class="price-amount">{{ fees.regular.member_indiv }}€</div>
                </div>
              </div>
              <div class="col-md-3 mb-4">
                <div class="price-header regular-price text-center">
                  <h4>{{ fees.categories.member_collective }}</h4>
                  <div class="price-amount">{{ fees.regular.member_collec }}€</div>
                </div>
              </div>
              <div class="col-md-3 mb-4">
                <div class="price-header regular-price text-center">
                  <h4>{{ fees.categories.non_member }}</h4>
                  <div class="price-amount">{{ fees.regular.not_member }}€</div>
                </div>
              </div>
            </div>
        </div>
        
        <!-- Ce qui est inclus -->
        <div class="row mb-5">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0"><i class="fas fa-check-circle me-2"></i>Inclus dans l'inscription</h4>
                    </div>
                    <div class="card-body">
                        {% for item in fees.included %}
                        <div class="included-item">
                            <i class="fas fa-check text-success me-2"></i>{{ item }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Options supplémentaires</h4>
                    </div>
                    <div class="card-body">
                        {% for option in fees.optional %}
                        <div class="optional-item d-flex justify-content-between align-items-center">
                            <span>{{ option.item }}</span>
                            <span class="badge bg-primary">+{{ option.price }}€</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        
        <!-- Conditions -->
        <div class="card mb-4">
            <div class="card-body">
                <h5><i class="fas fa-info-circle me-2"></i>Conditions d'inscription</h5>
                <ul>
                    {% for condition in fees.conditions %}
                    <li>{{ condition }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        
        <!-- Bouton inscription -->
        <div class="text-center">
            <h3 class="mb-3">Prêt à vous inscrire ?</h3>
            
            <button class="btn btn-primary btn-lg me-2" onclick="ouvrirInscription('participant')">
                <i class="fas fa-user-graduate me-2"></i>S'inscrire au congrès
            </button>
            <button class="btn btn-warning btn-lg" onclick="ouvrirInscription('accompagnant')">
                <i class="fas fa-user-friends me-2"></i>Inscrire un accompagnant
            </button>
            
            <div class="mt-3">
                <small class="text-muted">
                    <i class="fas fa-shield-alt me-1"></i>
                    Plateforme sécurisée • Paiement protégé
                </small>
            </div>
        </div>

        <!-- Modal pour l'inscription en iframe -->
        <div class="modal fade" id="inscriptionModal" tabindex="-1" aria-labelledby="inscriptionModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white;">
                        <div class="d-flex align-items-center w-100">
                            <div class="me-3">
                                <i class="fas fa-ticket-alt fa-2x"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5 class="modal-title mb-0" id="inscriptionModalLabel">
                                    Inscription {{ conference.short_name }}
                                </h5>
                                <small class="opacity-75">{{ conference.name }}</small>
                            </div>
                            <div class="me-3">
                                <span class="badge bg-success">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    Sécurisé
                                </span>
                            </div>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                    </div>
                    <div class="modal-body p-0">
                        <!-- Message de transition -->
                        <div class="alert alert-info m-3" id="transitionMessage" style="display: none;">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-sync-alt fa-spin me-2"></i>
                                <span>Chargement de la plateforme d'inscription sécurisée...</span>
                            </div>
                        </div>
                        
                        <!-- Iframe pour le formulaire externe -->
                        <iframe id="inscriptionIframe" 
                                style="width: 100%; height: 80vh; border: none;" 
                                src="" 
                                title="Formulaire d'inscription {{ conference.short_name }}">
                        </iframe>
                    </div>
                    <div class="modal-footer" style="background-color: #f8f9fa;">
                        <small class="text-muted me-auto">
                            <i class="fas fa-info-circle me-1"></i>
                            Vous restez sur le site officiel {{ conference.short_name }}
                        </small>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Fermer
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay de chargement -->
        <div id="loadingOverlay" style="
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        ">
            <div class="text-center">
                <div style="
                    width: 60px;
                    height: 60px;
                    border: 4px solid #f3f3f3;
                    border-top: 4px solid #007bff;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                "></div>
                <h5 class="text-primary">Préparation de votre inscription...</h5>
                <p class="text-muted">Connexion à la plateforme sécurisée</p>
            </div>
        </div>

        <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Animation pour les boutons */
        .btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        /* Effet de brillance sur les boutons */
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        /* Style pour l'iframe */
        #inscriptionIframe {
            border-radius: 0 0 10px 10px;
        }

        /* Responsive pour mobile */
        @media (max-width: 768px) {
            .modal-xl {
                margin: 0.5rem;
            }
            
            #inscriptionIframe {
                height: 70vh;
            }
        }
        </style>

        <script>
        // URLs des plateformes d'inscription
	const urlsInscription = {{ registration_urls|tojson }};
	  
        const conferenceName = "{{ conference.short_name }}";

        function ouvrirInscription(type) {
            // Afficher l'overlay de chargement
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            // Mettre à jour le titre du modal selon le type
            const titre = type === 'participant' ? 
                `Inscription Participant - ${conferenceName}` : 
                `Inscription Accompagnant - ${conferenceName}`;
            document.getElementById('inscriptionModalLabel').textContent = titre;
            
            // Afficher le message de transition
            document.getElementById('transitionMessage').style.display = 'block';
            
            // Simuler un délai de chargement pour une meilleure UX
            setTimeout(() => {
                // Masquer l'overlay
                document.getElementById('loadingOverlay').style.display = 'none';
                
                // Configurer l'iframe avec l'URL appropriée
                const iframe = document.getElementById('inscriptionIframe');
                iframe.src = urlsInscription[type];
                
                // Ouvrir le modal
                const modal = new bootstrap.Modal(document.getElementById('inscriptionModal'), {
                    backdrop: 'static', // Empêche la fermeture en cliquant à l'extérieur
                    keyboard: true      // Permet la fermeture avec Echap
                });
                modal.show();
                
                // Masquer le message de transition une fois l'iframe chargée
                iframe.onload = () => {
                    setTimeout(() => {
                        document.getElementById('transitionMessage').style.display = 'none';
                    }, 1000);
                };
                
                // Tracking analytics (optionnel)
                if (typeof gtag !== 'undefined') {
                    gtag('event', 'inscription_ouverture', {
                        'event_category': 'inscription',
                        'event_label': type,
                        'value': 1
                    });
                }
                
                console.log(`Ouverture inscription ${type}`);
            }, 800); // Délai de 800ms pour l'effet
        }

        // Gestion des événements du modal
        document.addEventListener('DOMContentLoaded', function() {
            const modal = document.getElementById('inscriptionModal');
            
            // Quand le modal se ferme
            modal.addEventListener('hidden.bs.modal', function () {
                // Vider l'iframe pour économiser les ressources
                document.getElementById('inscriptionIframe').src = '';
                
                // Masquer le message de transition
                document.getElementById('transitionMessage').style.display = 'none';
                
                console.log('Modal inscription fermé');
            });
            
            // Quand le modal s'ouvre
            modal.addEventListener('shown.bs.modal', function () {
                console.log('Modal inscription ouvert');
            });
        });

        // Gestion des messages depuis l'iframe (communication cross-origin si supportée)
        window.addEventListener('message', function(event) {
            // Vérifier l'origine pour la sécurité  
            
            const data = event.data;
            
            // Si inscription réussie
            if (data.type === 'inscription_success') {
                // Fermer le modal
                bootstrap.Modal.getInstance(document.getElementById('inscriptionModal')).hide();
                
                // Afficher un message de succès
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Inscription réussie !</strong> Vous allez recevoir un email de confirmation.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Insérer l'alerte en haut de la page
                document.querySelector('.row').insertBefore(alertDiv, document.querySelector('.row').firstChild);
                
                // Scroll vers le haut
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });

        // Amélioration UX : préchargement des iframes (optionnel)
        function prechargerIframes() {
            // Créer des iframes cachées pour accélérer le chargement
            Object.keys(urlsInscription).forEach(type => {
                const iframe = document.createElement('iframe');
                iframe.src = urlsInscription[type];
                iframe.style.display = 'none';
                iframe.style.width = '1px';
                iframe.style.height = '1px';
                document.body.appendChild(iframe);
            });
        }

        // Précharger après 2 secondes (pour ne pas ralentir le chargement initial)
        setTimeout(prechargerIframes, 2000);
        </script>
    </div>
</div>
{% endblock %}

