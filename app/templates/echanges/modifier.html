{% extends 'base.html' %}

{% block title %}Modifier - {{ message.title }} - {{ conference.short_name }}{% endblock %}

{% block extra_css %}
<style>
.form-section {
    background: white;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.section-title {
    color: #2c3e50;
    border-bottom: 2px solid #3498db;
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
}

.current-info {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 15px;
    margin-bottom: 2rem;
}

.info-badge {
    background: rgba(255,255,255,0.2);
    color: white;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.9em;
    margin-right: 10px;
    margin-bottom: 10px;
    display: inline-block;
}

.category-option {
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s;
}

.category-option:hover {
    border-color: #007bff;
    background: #f8f9fa;
}

.category-option.selected {
    border-color: #007bff;
    background: #e3f2fd;
}

.category-icon {
    font-size: 1.2em;
    margin-right: 0.5rem;
}

.char-counter {
    font-size: 0.85em;
    color: #6c757d;
    float: right;
}

.char-counter.warning {
    color: #ffc107;
}

.char-counter.danger {
    color: #dc3545;
}

.delete-section {
    background: #fff5f5;
    border: 1px solid #fed7d7;
    border-radius: 10px;
    padding: 1.5rem;
    margin-top: 2rem;
}

.visibility-section {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 1.5rem;
    border-left: 4px solid #28a745;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Navigation breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Accueil</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('main.echanges') }}">Échanges</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('main.mes_messages') }}">Mes messages</a></li>
            <li class="breadcrumb-item active">Modifier</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- En-tête -->
            <div class="text-center mb-4">
                <h1 class="display-5">
                    <i class="fas fa-edit text-primary me-2"></i>
                    Modifier le Message
                </h1>
                <p class="lead text-muted">Mettez à jour le contenu de votre message</p>
            </div>

            <!-- Informations actuelles -->
            <div class="current-info">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3 class="mb-3">{{ message.title }}</h3>
                        
                        <div class="mb-3">
                            <div class="info-badge">
                                {% if message.category.value == 'general' %}<i class="fas fa-comments me-1"></i> Général
                                {% elif message.category.value == 'technique' %}<i class="fas fa-cogs me-1"></i> Technique
                                {% elif message.category.value == 'logistique' %}<i class="fas fa-clipboard-list me-1"></i> Logistique
                                {% elif message.category.value == 'networking' %}<i class="fas fa-handshake me-1"></i> Networking
                                {% elif message.category.value == 'questions' %}<i class="fas fa-question-circle me-1"></i> Questions/Aide
                                {% elif message.category.value == 'annonces' %}<i class="fas fa-bullhorn me-1"></i> Annonces
                                {% else %}{{ message.category.value|title }}{% endif %}
                            </div>
                            
                            {% if message.topic %}
                            <div class="info-badge">
                                <i class="fas fa-tag me-1"></i>{{ message.topic }}
                            </div>
                            {% endif %}
                            
                            {% if message.is_pinned %}
                            <div class="info-badge bg-warning bg-opacity-75 text-dark">
                                <i class="fas fa-thumbtack me-1"></i>Épinglé
                            </div>
                            {% endif %}
                        </div>
                        
                        <p class="mb-2 opacity-75">
                            {{ message.content[:200] }}{% if message.content|length > 200 %}...{% endif %}
                        </p>
                    </div>
                    
                    <div class="col-md-4 text-center">
                        <div class="mb-2">
                            <i class="fas fa-eye fa-2x opacity-75"></i>
                            <h4 class="mb-0">{{ message.view_count }}</h4>
                            <small>Vue{{ 's' if message.view_count > 1 else '' }}</small>
                        </div>
                        <div class="mb-2">
                            <i class="fas fa-reply fa-2x opacity-75"></i>
                            <h4 class="mb-0">{{ message.replies_count }}</h4>
                            <small>Réponse{{ 's' if message.replies_count > 1 else '' }}</small>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 pt-3 border-top border-white border-opacity-25">
                    <small class="opacity-75">
                        Créé le {{ message.created_at.strftime('%d/%m/%Y à %H:%M') }}
                        {% if message.updated_at != message.created_at %}
                        • Dernière modification le {{ message.updated_at.strftime('%d/%m/%Y à %H:%M') }}
                        {% endif %}
                    </small>
                </div>
            </div>

            <form method="POST" id="editForm">
                {{ form.hidden_tag() }}
                
                <!-- Section 1: Informations principales -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-info-circle me-2"></i>Informations principales
                    </h3>
                    
                    <div class="mb-4">
                        {{ form.title.label(class="form-label") }}
                        {{ form.title(class="form-control form-control-lg", maxlength="200") }}
                        {% if form.title.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.title.errors %}
                                    <small><i class="fas fa-exclamation-triangle me-1"></i>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="char-counter" id="title-counter">{{ form.title.data|length if form.title.data else 0 }}/200 caractères</div>
                    </div>
                    
                    <div class="mb-4">
                        {{ form.topic.label(class="form-label") }}
                        {{ form.topic(class="form-control", maxlength="100") }}
                        {% if form.topic.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.topic.errors %}
                                    <small><i class="fas fa-exclamation-triangle me-1"></i>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Section 2: Catégorie -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-folder me-2"></i>Catégorie
                    </h3>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="category-option" data-category="general">
                                <input type="radio" name="category" value="general" id="cat-general" class="form-check-input me-2"
                                       {% if form.category.data == 'general' or (not form.category.data and message.category.value == 'general') %}checked{% endif %}>
                                <label for="cat-general" class="form-check-label w-100">
                                    <i class="fas fa-comments category-icon text-secondary"></i><strong>Général</strong>
                                    <div class="category-description small text-muted mt-1">Discussions ouvertes et sujets divers</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="category-option" data-category="technique">
                                <input type="radio" name="category" value="technique" id="cat-technique" class="form-check-input me-2"
                                       {% if form.category.data == 'technique' or (not form.category.data and message.category.value == 'technique') %}checked{% endif %}>
                                <label for="cat-technique" class="form-check-label w-100">
                                    <i class="fas fa-cogs category-icon text-primary"></i><strong>Technique</strong>
                                    <div class="category-description small text-muted mt-1">Questions scientifiques et techniques</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="category-option" data-category="logistique">
                                <input type="radio" name="category" value="logistique" id="cat-logistique" class="form-check-input me-2"
                                       {% if form.category.data == 'logistique' or (not form.category.data and message.category.value == 'logistique') %}checked{% endif %}>
                                <label for="cat-logistique" class="form-check-label w-100">
                                    <i class="fas fa-clipboard-list category-icon text-success"></i><strong>Logistique</strong>
                                    <div class="category-description small text-muted mt-1">Transport, hébergement, organisation</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="category-option" data-category="networking">
                                <input type="radio" name="category" value="networking" id="cat-networking" class="form-check-input me-2"
                                       {% if form.category.data == 'networking' or (not form.category.data and message.category.value == 'networking') %}checked{% endif %}>
                                <label for="cat-networking" class="form-check-label w-100">
                                    <i class="fas fa-handshake category-icon text-warning"></i><strong>Networking</strong>
                                    <div class="category-description small text-muted mt-1">Rencontres et collaborations</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="category-option" data-category="questions">
                                <input type="radio" name="category" value="questions" id="cat-questions" class="form-check-input me-2"
                                       {% if form.category.data == 'questions' or (not form.category.data and message.category.value == 'questions') %}checked{% endif %}>
                                <label for="cat-questions" class="form-check-label w-100">
                                    <i class="fas fa-question-circle category-icon text-danger"></i><strong>Questions/Aide</strong>
                                    <div class="category-description small text-muted mt-1">Demandes d'aide et réponses</div>
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <div class="category-option" data-category="annonces">
                                <input type="radio" name="category" value="annonces" id="cat-annonces" class="form-check-input me-2"
                                       {% if form.category.data == 'annonces' or (not form.category.data and message.category.value == 'annonces') %}checked{% endif %}>
                                <label for="cat-annonces" class="form-check-label w-100">
                                    <i class="fas fa-bullhorn category-icon text-info"></i><strong>Annonces</strong>
                                    <div class="category-description small text-muted mt-1">Informations et actualités</div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    {% if form.category.errors %}
                        <div class="text-danger mt-2">
                            {% for error in form.category.errors %}
                                <small><i class="fas fa-exclamation-triangle me-1"></i>{{ error }}</small>
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                <!-- Section 3: Contenu -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-edit me-2"></i>Contenu du message
                    </h3>
                    
                    <div class="mb-4">
                        {{ form.content.label(class="form-label") }}
                        {{ form.content(class="form-control", rows="8", maxlength="5000") }}
                        {% if form.content.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.content.errors %}
                                    <small><i class="fas fa-exclamation-triangle me-1"></i>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="char-counter" id="content-counter">{{ form.content.data|length if form.content.data else 0 }}/5000 caractères</div>
                    </div>
                </div>

                <!-- Section 4: Visibilité -->
                <div class="form-section">
                    <h3 class="section-title">
                        <i class="fas fa-eye me-2"></i>Visibilité
                    </h3>
                    
                    <div class="visibility-section">
                        <div class="form-check form-switch">
                            {{ form.is_public(class="form-check-input", role="switch") }}
                            <label class="form-check-label" for="{{ form.is_public.id }}">
                                <strong>{{ form.is_public.label.text }}</strong>
                            </label>
                        </div>
                        <div class="form-text mt-2">
                            {{ form.is_public.description }}
                        </div>
                        
                        {% if form.is_public.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.is_public.errors %}
                                    <small><i class="fas fa-exclamation-triangle me-1"></i>{{ error }}</small>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Section 5: Actions -->
                <div class="form-section">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <a href="{{ url_for('main.mes_messages') }}" class="btn btn-secondary btn-lg w-100">
                                <i class="fas fa-arrow-left me-2"></i>Retour à mes messages
                            </a>
                        </div>
                        <div class="col-md-6 mb-3">
                            {{ form.submit(class="btn btn-primary btn-lg w-100") }}
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <a href="{{ url_for('main.voir_message', message_id=message.id) }}" 
                           class="btn btn-outline-info">
                            <i class="fas fa-eye me-2"></i>Voir le message
                        </a>
                    </div>
                </div>

                <!-- Zone de suppression -->
                <div class="delete-section">
                    <h5 class="text-danger mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>Zone de danger
                    </h5>
                    <p class="text-muted mb-3">
                        {% if message.replies_count > 0 %}
                        Ce message a {{ message.replies_count }} réponse{{ 's' if message.replies_count > 1 else '' }}. 
                        Sa suppression l'archivera au lieu de le supprimer définitivement.
                        {% else %}
                        Une fois supprimé, ce message ne pourra pas être récupéré.
                        {% endif %}
                    </p>
                    <button type="button" class="btn btn-danger" 
                            onclick="confirmDelete({{ message.id }}, '{{ message.title|e }}')">
                        <i class="fas fa-trash me-2"></i>Supprimer ce message
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de confirmation de suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-trash-alt text-danger me-2"></i>Confirmer la suppression
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer ce message ?</p>
                <div class="alert alert-warning">
                    <strong id="message-title"></strong>
                </div>
                {% if message.replies_count > 0 %}
                <p class="small text-info">
                    <i class="fas fa-info-circle me-1"></i>
                    Ce message sera archivé car il a des réponses.
                </p>
                {% else %}
                <p class="small text-muted">Cette action est irréversible.</p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>Supprimer
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const titleInput = document.getElementById('title');
    const contentInput = document.getElementById('content');
    const titleCounter = document.getElementById('title-counter');
    const contentCounter = document.getElementById('content-counter');
    
    // Gestion des catégories
    const categoryOptions = document.querySelectorAll('.category-option');
    
    categoryOptions.forEach(option => {
        const radio = option.querySelector('input[type="radio"]');
        
        option.addEventListener('click', function() {
            // Décocher tous les autres
            categoryOptions.forEach(opt => {
                opt.classList.remove('selected');
            });
            
            // Cocher celui-ci
            radio.checked = true;
            option.classList.add('selected');
        });
        
        // État initial
        if (radio.checked) {
            option.classList.add('selected');
        }
    });
    
    // Mise à jour des compteurs
    function updateCharCounter(input, counter, maxLength) {
        const currentLength = input.value.length;
        counter.textContent = currentLength + '/' + maxLength + ' caractères';
        
        counter.classList.remove('warning', 'danger');
        
        if (currentLength > maxLength * 0.9) {
            counter.classList.add('warning');
        }
        if (currentLength > maxLength * 0.95) {
            counter.classList.add('danger');
            counter.classList.remove('warning');
        }
    }
    
    // Événements
    titleInput.addEventListener('input', function() {
        updateCharCounter(this, titleCounter, 200);
    });
    
    contentInput.addEventListener('input', function() {
        updateCharCounter(this, contentCounter, 5000);
    });
    
    // Initialisation des compteurs
    updateCharCounter(titleInput, titleCounter, 200);
    updateCharCounter(contentInput, contentCounter, 5000);
});

function confirmDelete(messageId, messageTitle) {
    document.getElementById('message-title').textContent = messageTitle;
    document.getElementById('deleteForm').action = '/echanges/message/' + messageId + '/supprimer';
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}
</script>
{% endblock %}
