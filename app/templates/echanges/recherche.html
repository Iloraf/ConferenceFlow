{% extends 'base.html' %}

{% block title %}Recherche - Échanges {{ conference.short_name }}{% endblock %}

{% block extra_css %}
<style>
.search-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem 0;
    margin-bottom: 3rem;
    border-radius: 15px;
}

.search-form {
    background: white;
    padding: 2rem;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.result-card {
    transition: all 0.3s ease;
    cursor: pointer;
    border-left: 4px solid transparent;
    margin-bottom: 1.5rem;
}

.result-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-left-color: #007bff;
}

.search-highlight {
    background: yellow;
    padding: 2px 4px;
    border-radius: 3px;
}

.no-results {
    text-align: center;
    padding: 4rem 2rem;
    background: #f8f9fa;
    border-radius: 15px;
    border: 2px dashed #dee2e6;
}

.search-stats {
    background: #e3f2fd;
    padding: 1rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    border-left: 4px solid #2196f3;
}

.category-filter {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 1rem;
}

.category-btn {
    padding: 6px 12px;
    border: 1px solid #dee2e6;
    background: white;
    border-radius: 15px;
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.3s;
}

.category-btn:hover,
.category-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.result-meta {
    font-size: 0.85em;
    color: #6c757d;
}

.search-tips {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    padding: 1rem;
    border-radius: 10px;
    margin-top: 2rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Navigation breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Accueil</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('main.echanges') }}">Échanges</a></li>
            <li class="breadcrumb-item active">Recherche</li>
        </ol>
    </nav>

    <!-- En-tête de recherche -->
    <div class="search-header text-center">
        <div class="container">
            <h1 class="display-5 mb-3">
                <i class="fas fa-search me-3"></i>Recherche dans les échanges
            </h1>
            <p class="lead">
                Trouvez rapidement les discussions et informations qui vous intéressent
            </p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mx-auto">
            <!-- Formulaire de recherche -->
            <div class="search-form">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            {{ form.query.label(class="form-label") }}
                            {{ form.query(class="form-control form-control-lg", placeholder="Rechercher dans les messages...", autofocus=true) }}
                            {% if form.query.errors %}
                                <div class="text-danger mt-2">
                                    {% for error in form.query.errors %}
                                        <small><i class="fas fa-exclamation-triangle me-1"></i>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">{{ form.query.description }}</div>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            {{ form.category.label(class="form-label") }}
                            {{ form.category(class="form-select") }}
                            {% if form.category.errors %}
                                <div class="text-danger mt-2">
                                    {% for error in form.category.errors %}
                                        <small><i class="fas fa-exclamation-triangle me-1"></i>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="text-center">
                        {{ form.submit(class="btn btn-primary btn-lg px-5") }}
                        <a href="{{ url_for('main.echanges') }}" class="btn btn-outline-secondary btn-lg ms-2">
                            <i class="fas fa-arrow-left me-2"></i>Retour aux échanges
                        </a>
                    </div>
                </form>
            </div>

            <!-- Résultats de recherche -->
            {% if form.query.data %}
                {% if results %}
                    <!-- Statistiques des résultats -->
                    <div class="search-stats">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>{{ results|length }}</strong> résultat{{ 's' if results|length > 1 else '' }} 
                        pour "<strong>{{ form.query.data }}</strong>"
                        {% if form.category.data %}
                        dans la catégorie "<strong>{{ dict(form.category.choices).get(form.category.data) }}</strong>"
                        {% endif %}
                    </div>

                    <!-- Liste des résultats -->
                    {% for message in results %}
                    <div class="card result-card"
                         onclick="window.location.href='{{ url_for('main.voir_message', message_id=message.id) }}'">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex align-items-start mb-2">
                                        <span class="badge bg-secondary me-2">
                                            {% if message.category.value == 'general' %}<i class="fas fa-comments me-1"></i> Général
                                            {% elif message.category.value == 'technique' %}<i class="fas fa-cogs me-1"></i> Technique
                                            {% elif message.category.value == 'logistique' %}<i class="fas fa-clipboard-list me-1"></i> Logistique
                                            {% elif message.category.value == 'networking' %}<i class="fas fa-handshake me-1"></i> Networking
                                            {% elif message.category.value == 'questions' %}<i class="fas fa-question-circle me-1"></i> Questions
                                            {% elif message.category.value == 'annonces' %}<i class="fas fa-bullhorn me-1"></i> Annonces
                                            {% else %}{{ message.category.value|title }}{% endif %}
                                        </span>
                                        
                                        {% if message.is_pinned %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-thumbtack me-1"></i>Épinglé
                                        </span>
                                        {% endif %}
                                    </div>
                                    
                                    <h5 class="card-title mb-2">{{ message.title }}</h5>
                                    
                                    {% if message.topic %}
                                    <p class="mb-2">
                                        <small class="text-muted">
                                            <i class="fas fa-tag me-1"></i>{{ message.topic }}
                                        </small>
                                    </p>
                                    {% endif %}
                                    
                                    <p class="card-text text-muted">
                                        {{ message.content[:250] }}{% if message.content|length > 250 %}...{% endif %}
                                    </p>
                                    
                                    <div class="result-meta">
                                        <i class="fas fa-user me-1"></i>{{ message.user.first_name }} {{ message.user.last_name[:1] }}.
                                        <span class="ms-3">
                                            <i class="fas fa-clock me-1"></i>{{ message.created_at.strftime('%d/%m/%Y') }}
                                        </span>
                                        {% if message.updated_at != message.created_at %}
                                        <span class="ms-2 text-warning">
                                            <i class="fas fa-edit me-1"></i>Modifié
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <div class="col-md-4 text-end">
                                    <div class="result-meta">
                                        <div class="mb-1">
                                            <i class="fas fa-eye me-1"></i>{{ message.view_count }} vue{{ 's' if message.view_count > 1 else '' }}
                                        </div>
                                        <div class="mb-1">
                                            <i class="fas fa-reply me-1"></i>{{ message.replies_count }} réponse{{ 's' if message.replies_count > 1 else '' }}
                                        </div>
                                        {% if message.reactions %}
                                        <div>
                                            <i class="fas fa-heart me-1"></i>{{ message.reactions|length }} réaction{{ 's' if message.reactions|length > 1 else '' }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mt-3">
                                        <a href="{{ url_for('main.voir_message', message_id=message.id) }}" 
                                           class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation()">
                                            <i class="fas fa-eye me-1"></i>Voir
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}

                {% else %}
                    <!-- Aucun résultat -->
                    <div class="no-results">
                        <div class="mb-4">
                            <i class="fas fa-search-minus fa-4x text-muted mb-3"></i>
                            <h3 class="text-muted">Aucun résultat trouvé</h3>
                            <p class="lead">Votre recherche pour "<strong>{{ form.query.data }}</strong>" n'a donné aucun résultat.</p>
                        </div>
                        
                        <div class="text-start">
                            <h6 class="mb-3">Suggestions :</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2">
                                    <i class="fas fa-lightbulb text-warning me-2"></i>
                                    Vérifiez l'orthographe de vos mots-clés
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-search text-info me-2"></i>
                                    Essayez des termes plus généraux ou différents
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-filter text-success me-2"></i>
                                    Changez ou supprimez le filtre de catégorie
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-plus-circle text-primary me-2"></i>
                                    Ou <a href="{{ url_for('main.nouveau_message') }}">créez un nouveau message</a> sur ce sujet
                                </li>
                            </ul>
                        </div>
                    </div>
                {% endif %}
            {% endif %}

            <!-- Conseils de recherche -->
            <div class="search-tips">
                <h6><i class="fas fa-lightbulb text-warning me-2"></i>Conseils de recherche</h6>
                <ul class="mb-0 small">
                    <li>Utilisez des mots-clés pertinents (ex: "thermique", "simulation", "matériaux")</li>
                    <li>La recherche porte sur les titres, contenus et sujets des messages</li>
                    <li>Filtrez par catégorie pour des résultats plus précis</li>
                    <li>Les termes de moins de 3 caractères sont ignorés</li>
                </ul>
            </div>
            
            <!-- Raccourcis vers les catégories populaires -->
            {% if not form.query.data %}
            <div class="text-center mt-4">
                <h5 class="mb-3">Ou parcourez par catégorie :</h5>
                <div class="category-filter justify-content-center">
                    <a href="{{ url_for('main.echanges_categorie', category_name='technique') }}" 
                       class="category-btn">
                        <i class="fas fa-cogs me-1"></i>Technique
                    </a>
                    <a href="{{ url_for('main.echanges_categorie', category_name='questions') }}" 
                       class="category-btn">
                        <i class="fas fa-question-circle me-1"></i>Questions
                    </a>
                    <a href="{{ url_for('main.echanges_categorie', category_name='networking') }}" 
                       class="category-btn">
                        <i class="fas fa-handshake me-1"></i>Networking
                    </a>
                    <a href="{{ url_for('main.echanges_categorie', category_name='logistique') }}" 
                       class="category-btn">
                        <i class="fas fa-clipboard-list me-1"></i>Logistique
                    </a>
                    <a href="{{ url_for('main.echanges_categorie', category_name='general') }}" 
                       class="category-btn">
                        <i class="fas fa-comments me-1"></i>Général
                    </a>
                    <a href="{{ url_for('main.echanges_categorie', category_name='annonces') }}" 
                       class="category-btn">
                        <i class="fas fa-bullhorn me-1"></i>Annonces
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
// Animation d'entrée pour les résultats
document.addEventListener('DOMContentLoaded', function() {
    const results = document.querySelectorAll('.result-card');
    results.forEach((result, index) => {
        result.style.opacity = '0';
        result.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
            result.style.transition = 'all 0.5s ease';
            result.style.opacity = '1';
            result.style.transform = 'translateY(0)';
        }, index * 100);
    });
    
    // Focus sur le champ de recherche si vide
    const searchInput = document.querySelector('input[name="query"]');
    if (searchInput && !searchInput.value) {
        searchInput.focus();
    }
});
</script>
{% endblock %}
